function addTool(a,b,c){"use strict";function d(b,c){var d=b.interactionBox;if(d.valid&&(y.position.fromArray(d.center),y.scale.set(d.width*e,d.height*e,d.depth*e)),1===b.tools.length){var f=b.tools[0];f.timeVisible>m&&(u.visible=!0,E.opacity=F.opacity=1,x.opacity=p,A.opacity=q,I.position.fromArray(f.tipPosition),fa.fromArray(f.direction),I.quaternion.setFromUnitVectors(ea,fa),f.timeVisible>n&&(L.sleepState===CANNON.Body.SLEEPING&&(L.wakeUp(),F.color.setHex(16711680)),ga.set(0,0,0),I.localToWorld(ga),L.position.copy(ga),ha.set(.001*f.tipVelocity[0],.001*f.tipVelocity[1],.001*f.tipVelocity[2]),ha.applyQuaternion(a.quaternion),L.velocity.copy(ha)))}else L.sleepState===CANNON.Body.AWAKE?(L.sleep(),F.color.setHex(H)):(F.opacity*=.9,E.opacity*=.9,x.opacity*=.9,A.opacity*=.9,F.opacity<.1&&(u.visible=!1));M.visible=N.visible=!1;for(var g=0;g<b.hands.length;g++){var h=b.hands[g];if(h.confidence>o){O[g].visible=!0,P.opacity=(h.confidence-o)/(1-o),fa.fromArray(h.arm.basis[2]),U[g].quaternion.setFromUnitVectors(ea,fa);var i=h.arm.center();U[g].position.fromArray(i),fa.fromArray(h.palmNormal),Y[g].quaternion.setFromUnitVectors(ea,fa),Y[g].position.fromArray(h.palmPosition);for(var j=0;j<h.fingers.length;j++){var k=h.fingers[j];_[g][j].position.fromArray(k.tipPosition),ba[g][j].position.fromArray(k.bones[1].nextJoint),da[g][j].position.fromArray(k.bones[2].nextJoint)}}}}c=c||{};var e,f=c.toolLength||.5,g=c.toolRadius||.013,h=c.toolMass||.06,i=c.tipRadius||.95*g,j=c.tipMinorRadius||.4*g,k=c.toolOffset||new THREE.Vector3(0,-.4,-f-.2),l=c.handOffset||new THREE.Vector3(0,-.25,-.4),m=c.toolTime||.25,n=c.toolTimeB||m+1,o=c.minConfidence||.3,p=c.interactionBoxOpacity||(c.useBasicMaterials===!1?.1:.25),q=c.interactionPlaneOpacity||p,r=new Leap.Controller({frameEventName:"animationFrame"}),s=c.transformOptions;s?(r.use("transform",s),pyserver.log("transformOptions =\n"+JSON.stringify(s,void 0,2)),s.vr===!0&&(k.set(0,0,0),l.set(0,0,0)),e=1):e=.001;var t=c.onConnect||function(){pyserver.log("Leap Motion WebSocket connected")};r.on("connect",t),c.onStreamingStarted&&r.on("streamingStarted",c.onStreamingStarted),c.onStreamingStopped&&r.on("streamingStopped",c.onStreamingStopped),r.connect();var u=new THREE.Object3D;u.position.copy(k),u.scale.set(e,e,e),a.add(u);var v=new THREE.BufferGeometry,w=new THREE.BoxGeometry(1/e,1/e,1/e);v.fromGeometry(w),w.dispose();var x=new THREE.MeshBasicMaterial({color:11175936,transparent:!0,opacity:p,side:THREE.BackSide}),y=new THREE.Mesh(v,x),z=new THREE.PlaneBufferGeometry(1/e,1/e),A=new THREE.MeshBasicMaterial({color:56644,transparent:!0,opacity:q}),B=new THREE.Mesh(z,A);y.add(B),u.add(y);var C=new THREE.CylinderGeometry(g/e,g/e,f/e,10,1,!1);C.translate(0,-f/e/2,0);var D=new THREE.BufferGeometry;D.fromGeometry(C),C.dispose(),C=D;var E,F,G=15645593,H=17544;c.useBasicMaterials?(E=new THREE.MeshBasicMaterial({color:G,side:THREE.DoubleSide,transparent:!0}),F=new THREE.MeshBasicMaterial({color:H,transparent:!0})):(E=new THREE.MeshLambertMaterial({color:G,side:THREE.DoubleSide,transparent:!0}),F=new THREE.MeshLambertMaterial({color:H,transparent:!0}));var I=new THREE.Mesh(C,E);I.castShadow=!0,u.add(I);var J=new THREE.SphereBufferGeometry(i/e,10);J.scale(1,j/i,1);var K=new THREE.Mesh(J,F);K.castShadow=!0,I.add(K);var L=new CANNON.Body({mass:h,type:CANNON.Body.KINEMATIC});L.addShape(new CANNON.Ellipsoid(i,j,i)),b.addBody(L),u.visible=!1;var M=new THREE.Object3D,N=new THREE.Object3D;M.position.copy(l),M.scale.set(e,e,e),N.position.copy(l),N.scale.set(e,e,e);var O=[M,N];a.add(M),a.add(N);var P=new THREE.MeshBasicMaterial({color:1127321,transparent:!0,opacity:0}),Q=.0276/e,R=.26/e,S=new THREE.CylinderGeometry(Q,Q,R);D=new THREE.BufferGeometry,D.fromGeometry(S),S.dispose(),S=D;var T=new THREE.Mesh(S,P),U=[T,T.clone()];M.add(U[0]),N.add(U[1]);var V=.025/e,W=new THREE.SphereBufferGeometry(V).scale(1,.5,1),X=new THREE.Mesh(W,P);X.castShadow=!0;var Y=[X,X.clone()];M.add(Y[0]),N.add(Y[1]),V=.005/e;var Z=new THREE.SphereBufferGeometry(V),$=new THREE.Mesh(Z,P),_=[[$,$.clone(),$.clone(),$.clone(),$.clone()],[$.clone(),$.clone(),$.clone(),$.clone(),$.clone()]];M.add(_[0][0],_[0][1],_[0][2],_[0][3],_[0][4]),N.add(_[1][0],_[1][1],_[1][2],_[1][3],_[1][4]);var aa=$.clone();aa.scale.set(1.4,1.4,1.4);var ba=[[aa,aa.clone(),aa.clone(),aa.clone(),aa.clone()],[aa.clone(),aa.clone(),aa.clone(),aa.clone(),aa.clone()]];M.add(ba[0][0],ba[0][1],ba[0][2],ba[0][3],ba[0][4]),N.add(ba[1][0],ba[1][1],ba[1][2],ba[1][3],ba[1][4]);var ca=$.clone();ca.scale.set(1.1,1.1,1.1);var da=[[ca,ca.clone(),ca.clone(),ca.clone(),ca.clone()],[ca.clone(),ca.clone(),ca.clone(),ca.clone(),ca.clone()]];M.add(da[0][0],da[0][1],da[0][2],da[0][3],da[0][4]),N.add(da[1][0],da[1][1],da[1][2],da[1][3],da[1][4]);var ea=new THREE.Vector3(0,1,0),fa=new THREE.Vector3,ga=new THREE.Vector3,ha=new THREE.Vector3;return{stickMesh:I,tipMesh:K,tipBody:L,toolRoot:u,leapController:r,animateLeap:d}}function onLoad(){"use strict";if(pyserver.log("starting poolvr..."),pyserver.log("POOLVR.config =\n"+JSON.stringify(POOLVR.config,void 0,2)),app=new WebVRApplication("poolvr",avatar,scene,POOLVR.config),avatar.add(app.camera),scene.add(avatar),!POOLVR.config.useBasicMaterials){var a=new THREE.SpotLight(16777198,1,10,90);a.position.set(0,3,0),a.castShadow=!0,a.shadowCameraNear=.01,a.shadowCameraFar=4,a.shadowCameraFov=90,scene.add(a)}CrapLoader.CANNONize(scene,app.world),app.world.addContactMaterial(POOLVR.ballBallContactMaterial),app.world.addContactMaterial(POOLVR.ballPlayableSurfaceContactMaterial),app.world.addContactMaterial(POOLVR.ballCushionContactMaterial),app.world.addContactMaterial(POOLVR.floorBallContactMaterial);var b=[];scene.traverse(function(a){a.name.startsWith("ballMesh")?(a.body.material=POOLVR.ballMaterial,a.body.bounces=0):a.name.startsWith("ballStripeMesh")?b.push(a):a.name.startsWith("playableSurfaceMesh")?a.body.material=POOLVR.playableSurfaceMaterial:a.name.endsWith("CushionMesh")?a.body.material=POOLVR.cushionMaterial:"floorMesh"===a.name&&(a.body.material=POOLVR.floorMaterial)});var c={transformOptions:POOLVR.config.transformOptions,useBasicMaterials:POOLVR.config.useBasicMaterials,toolLength:POOLVR.config.toolLength,toolRadius:POOLVR.config.toolRadius,toolMass:POOLVR.config.toolMass,toolOffset:POOLVR.config.toolOffset};POOLVR.config.vrLeap&&(c.transformOptions={vr:!0,effectiveParent:app.camera}),pyserver.log("toolOptions =\n"+JSON.stringify(c,void 0,2));var d=addTool(avatar,app.world,c),e=d.toolRoot,f=d.leapController,g=(d.stickMesh,d.animateLeap),h=app.world.bodies.filter(function(a){return a.mesh&&a.type===CANNON.Body.DYNAMIC});app.start(animate(f,g,h,b,e,POOLVR.config.shadowMap,d.stickMesh,d.tipMesh,POOLVR.config.H_table,POOLVR.floorMaterial,POOLVR.ballMaterial)),startTutorial()}function setupMouse(){}function setupMenu(a){"use strict";var b=new THREE.TextGeometry("RESET TABLE",{font:"anonymous pro",size:.2,height:0}),c=new THREE.Mesh(b);c.position.set(0,1,-2),a.add(c)}function startTutorial(){"use strict";synthSpeaker.speak("Hello.  Welcome to pool-ver",function(){textGeomLogger.log("HELLO.  WELCOME TO POOLVR.")}),synthSpeaker.speak("Please wave a stick-like object in front of your Leap Motion controller.",function(){textGeomLogger.log("PLEASE WAVE A STICK-LIKE OBJECT IN FRONT OF YOUR LEAP MOTION CONTROLLER.")}),synthSpeaker.speak("Keep the stick within the interaction box when you want to make contact with a ball.",function(){textGeomLogger.log("KEEP THE STICK WITHIN THE INTERACTION BOX WHEN YOU WANT TO MAKE CONTACT WITH A BALL.")})}WebVRApplication=function(){function a(a,b,c,d){this.name=a,this.avatar=b,this.scene=c,this.config=d;var e=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);this.camera=e;var f=new THREE.WebGLRenderer({antialias:!0,alpha:!0});this.renderer=f,this.renderer.setPixelRatio(window.devicePixelRatio),d.shadowMap&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap),document.body.appendChild(this.renderer.domElement),this.vrEffect=new THREE.VREffect(this.renderer),this.vrEffect.setSize(window.innerWidth,window.innerHeight),this.vrManager=new WebVRManager(this.renderer,this.vrEffect,{hideButton:!1}),this.vrControls=new THREE.VRControls(this.camera),this.vrControls.enabled=!1,this.resetVRSensor=function(){this.vrControls.resetSensor()}.bind(this),this.toggleVRControls=function(){this.vrControls.enabled?(this.vrControls.enabled=!1,this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1)):(this.vrControls.enabled=!0,this.vrControls.update())}.bind(this);var g=new THREE.MeshBasicMaterial({color:15654314,wireframe:!0});this.toggleWireframe=function(){this.scene.overrideMaterial?this.scene.overrideMaterial=null:this.scene.overrideMaterial=g}.bind(this);var h={toggleVRControls:{buttons:[Primrose.Input.Keyboard.V],commandDown:this.toggleVRControls.bind(this),dt:.25},toggleWireframe:{buttons:[Primrose.Input.Keyboard.NUMBER0],commandDown:this.toggleWireframe.bind(this),dt:.25},resetVRSensor:{buttons:[Primrose.Input.Keyboard.Z],commandDown:this.resetVRSensor.bind(this),dt:.25}};d.keyboardCommands=combineDefaults(d.keyboardCommands||{},h),d.keyboardCommands=Object.keys(d.keyboardCommands).map(function(a){return combineDefaults({name:a},d.keyboardCommands[a])}),this.keyboard=new Primrose.Input.Keyboard("keyboard",window,d.keyboardCommands);var i={resetVRSensor:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.back],commandDown:this.resetVRSensor.bind(this),dt:.25}};d.gamepadCommands=combineDefaults(d.gamepadCommands||{},i),d.gamepadCommands=Object.keys(d.gamepadCommands).map(function(a){return combineDefaults({name:a},d.gamepadCommands[a])}),this.gamepad=new Primrose.Input.Gamepad("gamepad",d.gamepadCommands),this.gamepad.addEventListener("gamepadconnected",function(a){this.gamepad.isGamepadSet()||(this.gamepad.setGamepad(a),console.log("gamepad "+a+" connected"))}.bind(this),!1),this.listeners={update:[]};var j;d.world?j=d.world:(j=new CANNON.World,j.gravity.set(0,-d.gravity,0),j.broadphase=new CANNON.SAPBroadphase(j),j.defaultContactMaterial.contactEquationStiffness=d.contactEquationStiffness||1e7,j.defaultContactMaterial.frictionEquationStiffness=d.frictionEquationStiffness||1e7,j.defaultContactMaterial.contactEquationRelaxation=d.contactEquationRelaxation||3,j.defaultContactMaterial.frictionEquationRelaxation=d.frictionEquationRelaxation||3,j.solver.iterations=10),this.world=j;var k=this.renderer.domElement.mozRequestFullScreen?"mozfullscreenchange":"webkitfullscreenchange";document.addEventListener(k,function(a){this.vrManager.isVRMode()&&(this.vrControls.enabled=!0)}.bind(this),!1),this.start=function(a){function b(){if(CrapLoader.isLoaded()){CrapLoader.CANNONize(c,j);for(var d=0;480>d;d++)j.step(1/240);requestAnimationFrame(a)}else requestAnimationFrame(b)}b()}}return a}();var CrapLoader=function(){"use strict";function a(){return e}function b(a,b){function c(a){a.traverse(function(a){a instanceof THREE.Mesh&&(a.geometry.computeBoundingSphere(),a.geometry.computeBoundingBox(),a.userData&&a.userData.visible===!1&&(a.visible=!1),a.geometry instanceof THREE.SphereBufferGeometry||a.geometry.computeVertexNormals(),a.material.shading===THREE.FlatShading&&a.geometry.computeFaceNormals())})}b&&f.setTexturePath(b),a.materials&&a.materials.forEach(function(a){if(a.type.endsWith("ShaderMaterial")&&a.uniforms){var b=a.uniforms;for(var c in b){var d=b[c];"t"===d.type&&(Array.isArray(d.value)&&6==d.value.length?(e=!1,d.value=h.load(d.value)):"string"==typeof d.value&&(e=!1,d.value=g.load(d.value)))}}});var d=f.parseGeometries(a.geometries.filter(function(a){return"TextGeometry"!=a.type}));a.geometries.forEach(function(a){if("TextGeometry"==a.type){var b=new THREE.TextGeometry(a.text,a.parameters);b.uuid=a.uuid,void 0!==a.name&&(b.name=a.name),d[a.uuid]=b}});var i=f.parseImages(a.images,function(){c(l)}),j=f.parseTextures(a.textures,i),k=f.parseMaterials(a.materials,j),l=f.parseObject(a.object,d,k);return(void 0===a.images||0===a.images.length)&&c(l),l}function c(a,b){function c(a,b){var d,e;if(a.body)return a.body;if(a instanceof THREE.Mesh){i.copy(a.position);var f={mass:b.mass,position:a.localToWorld(i),quaternion:a.quaternion};return void 0!==b.linearDamping&&(f.linearDamping=b.linearDamping),void 0!==b.angularDamping&&(f.angularDamping=b.angularDamping),d=new CANNON.Body(f),d.mesh=a,b.shapes.forEach(function(b){var c,e,f,g;switch(b){case"Plane":c=new CANNON.Plane,f=new CANNON.Quaternion,f.setFromEuler(-Math.PI/2,0,0,"XYZ");break;case"Box":var h=new CANNON.Vec3;a.geometry.computeBoundingBox(),h.x=a.scale.x*(a.geometry.boundingBox.max.x-a.geometry.boundingBox.min.x)/2,h.y=a.scale.y*(a.geometry.boundingBox.max.y-a.geometry.boundingBox.min.y)/2,h.z=a.scale.z*(a.geometry.boundingBox.max.z-a.geometry.boundingBox.min.z)/2,c=new CANNON.Box(h);break;case"Sphere":a.geometry.computeBoundingSphere(),c=new CANNON.Sphere(a.geometry.boundingSphere.radius);break;case"ConvexPolyhedron":var i=[],j=[];if(a.geometry instanceof THREE.BufferGeometry){g=a.geometry.getAttribute("position").array;for(var k=0;k<g.length;k+=3)i.push(new CANNON.Vec3(g[k],g[k+1],g[k+2]));for(g=a.geometry.index.array,k=0;k<g.length;k+=3){var l=[g[k],g[k+1],g[k+2]];j.push(l)}}else a.geometry instanceof THREE.Geometry;c=new CANNON.ConvexPolyhedron(i,j);break;case"Cylinder":c=new CANNON.Cylinder(a.geometry.parameters.radiusTop,a.geometry.parameters.radiusBottom,a.geometry.parameters.height,a.geometry.parameters.radialSegments);break;default:console.log("unknown shape type: "+b)}d.addShape(c,e,f)}),a.body=d,d}return a instanceof THREE.Object3D?(e=[],a.children.forEach(function(a){e.push(c(a,b))}),e):void console.log("makeCANNON error")}a.traverse(function(a){if(a.userData&&a.userData.cannonData){var d=c(a,a.userData.cannonData);b&&(d instanceof CANNON.Body?b.addBody(d):d.forEach(function(a){b.addBody(a)}))}})}var d=new THREE.LoadingManager,e=!0;d.onLoad=function(){e=!0};var f=new THREE.ObjectLoader(d),g=(new THREE.ImageLoader(d),new THREE.TextureLoader(d)),h=new THREE.CubeTextureLoader(d),i=new THREE.Vector3;return{parse:b,CANNONize:c,isLoaded:a}}(),TextGeomLogger=function(){"use strict";function a(a,b){a=a||new THREE.MeshBasicMaterial({color:15606272}),b=b||{};var c={size:b.size||.12,font:b.font||"anonymous pro",height:b.height||0,curveSegments:b.curveSegments||2};this.geometries={},this.meshes={};for(var d=0;d<e.length;d++){var f=e[d],g=new THREE.TextGeometry(f,c),h=new THREE.BufferGeometry;h.fromGeometry(g),g.dispose(),this.geometries[f]=h,this.meshes[f]=new THREE.Mesh(g,a)}var i=b.nrows||20,j={};this.root=new THREE.Object3D,this.log=function(a){for(var b=a.split("\n"),d=0;d<this.root.children.length;d++){var e=this.root.children[d];e.position.y+=1.6*c.size}for(d=0;d<b.length;d++){var f=b[d],g=j[f];if(g){var h=g.clone();h.position.y=0,this.root.add(h)}else{g=new THREE.Object3D,this.root.add(g),j[f]=g;for(var k=0;k<f.length;k++){var l=f[k];if(" "!==l){var m=this.meshes[l].clone();m.position.x=.8*c.size*k,g.add(m)}}}}for(;this.root.children.length>i;)this.root.remove(this.root.children[-1])}.bind(this)}var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",c="0123456789",d=",./;'[]\\-=<>?:\"{}|_+~!@#$%^&*()",e=b+c+d;return a}(),WebVRSound=function(a){"use strict";function b(){var b=d[g];return g=(g+1)%a,b}a=a||4;for(var c=new AudioContext,d=[],e=0;a>e;e++){var f=c.createGain();f.connect(c.destination),f.gain.value=1,d.push(f)}var g=0,h=function(a,d){var e=c.createBufferSource(),f=b();f.gain.value=d,e.connect(f),e.buffer=a,e.start(0)};return{audioContext:c,getNextGainNode:b,playBuffer:h}}(),SynthSpeaker=function(){"use strict";function a(a){a=a||{},this.volume=a.volume||1,this.rate=a.rate||1,this.pitch=a.pitch||1,this.queue=[],this.onBegins=[],this.onEnds=[],this.speaking=!1;var b=function(){var a=this.onEnds.shift();if(a&&a(),this.queue.length>0){this.utterance=new SpeechSynthesisUtterance,this.utterance.volume=this.volume,this.utterance.rate=this.rate,this.utterance.pitch=this.pitch,this.utterance.onend=b,this.utterance.text=this.queue.shift();var c=this.onBegins.shift();c&&c(),speechSynthesis.speak(this.utterance)}else this.speaking=!1}.bind(this);this.utterance=new SpeechSynthesisUtterance,this.utterance.onend=b,this.utterance.volume=this.volume,this.utterance.rate=this.rate,this.utterance.pitch=this.pitch}return a.prototype.speak=function(a,b,c){this.onEnds.push(c),this.speaking?(this.queue.push(a),this.onBegins.push(b)):(b&&b(),this.utterance.text=a,this.speaking=!0,speechSynthesis.speak(this.utterance))},window.speechSynthesis?a:(console.log("speechSynthesis not supported"),function(){this.volume=0,this.rate=1,this.pitch=1,this.speak=function(a,b,c){b&&b(),c&&c()}})}(),pyserver;pyserver=POOLVR.config.pyserver?{log:function(a,b){"use strict";var c=new XMLHttpRequest,d=new FormData;d.append("msg",a),c.open("POST","/log"),c.onload=function(){var a=JSON.parse(c.responseText);b&&b(a)},c.send(d)},readFile:function(a,b,c){"use strict";var d=new XMLHttpRequest;d.open("GET","/read?file="+a),d.onload=function(){var a=JSON.parse(d.responseText);a.text?b(a.text):a.error&&(console.log(a.error),c&&c.log(a.error))},d.send()},writeFile:function(a,b){"use strict";var c=new XMLHttpRequest;if(c.open("POST","/write?file="+a),c.onload=function(){var a=JSON.parse(c.responseText);a.filename?console.log("wrote "+a.filename):a.error&&console.log(a.error)},"string"==typeof b){var d=new FormData;d.append("text",b),c.send(d)}else c.setRequestHeader("Content-Type","application/json"),c.send(JSON.stringify(b))}}:{log:function(a){console.log("pyserver.log: "+a)},readFile:function(){},writeFile:function(){}};var URL_PARAMS=function(){"use strict";var a={};location.search.substr(1).split("&").forEach(function(b){var c=b.split("=")[0],d=decodeURIComponent(b.split("=")[1]);c in a?a[c].push(d):a[c]=[d]});for(var b in a)1==a[b].length&&(a[b]=a[b][0]),"true"===a[b]?a[b]=!0:"false"===a[b]&&(a[b]=!1);return a}();POOLVR.config.keyboardCommands={turnLeft:{buttons:[-Primrose.Input.Keyboard.LEFTARROW]},turnRight:{buttons:[Primrose.Input.Keyboard.RIGHTARROW]},driveForward:{buttons:[-Primrose.Input.Keyboard.W]},driveBack:{buttons:[Primrose.Input.Keyboard.S]},strafeLeft:{buttons:[-Primrose.Input.Keyboard.A]},strafeRight:{buttons:[Primrose.Input.Keyboard.D]},floatUp:{buttons:[Primrose.Input.Keyboard.E,Primrose.Input.Keyboard.NUMBER9]},floatDown:{buttons:[-Primrose.Input.Keyboard.C,-Primrose.Input.Keyboard.NUMBER3]},moveToolUp:{buttons:[Primrose.Input.Keyboard.O]},moveToolDown:{buttons:[Primrose.Input.Keyboard.PERIOD]},moveToolForwards:{buttons:[Primrose.Input.Keyboard.I]},moveToolBackwards:{buttons:[Primrose.Input.Keyboard.K]},moveToolLeft:{buttons:[Primrose.Input.Keyboard.J]},moveToolRight:{buttons:[Primrose.Input.Keyboard.L]}};var DEADZONE=.2;POOLVR.config.gamepadCommands={strafe:{axes:[Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},drive:{axes:[Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},dheading:{axes:[-Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},pitch:{axes:[Primrose.Input.Gamepad.LSY],integrate:!0,deadzone:DEADZONE,max:.5*Math.PI,min:-.5*Math.PI},"float":{axes:[-Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},toggleFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.leftStick],commandDown:function(){avatar.floatMode=!0},commandUp:function(){avatar.floatMode=!1}},toolStrafe:{axes:[Primrose.Input.Gamepad.RSX],deadzone:DEADZONE},toolDrive:{axes:[Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toolFloat:{axes:[-Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toggleToolFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.rightStick],commandDown:function(){avatar.toolMode=!0},commandUp:function(){avatar.toolMode=!1}}},POOLVR.ballMaterial=new CANNON.Material,POOLVR.ballBallContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.ballMaterial,{restitution:.91,friction:.15}),POOLVR.playableSurfaceMaterial=new CANNON.Material,POOLVR.ballPlayableSurfaceContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.playableSurfaceMaterial,{restitution:.33,friction:.17}),POOLVR.cushionMaterial=new CANNON.Material,POOLVR.ballCushionContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.cushionMaterial,{restitution:.8,friction:.13}),POOLVR.floorMaterial=new CANNON.Material,POOLVR.floorBallContactMaterial=new CANNON.ContactMaterial(POOLVR.floorMaterial,POOLVR.ballMaterial,{restitution:.88,friction:.4}),POOLVR.config.mouseEnabled=URL_PARAMS.mouseEnabled||POOLVR.config.mouseEnabled,POOLVR.config.vrLeap=URL_PARAMS.vrLeap||POOLVR.config.vrLeap,POOLVR.config.toolLength=URL_PARAMS.toolLength||POOLVR.config.toolLength||.5,POOLVR.config.toolRadius=URL_PARAMS.toolRadius||POOLVR.config.toolRadius||.013,POOLVR.config.toolMass=URL_PARAMS.toolMass||POOLVR.config.toolMass||.06,URL_PARAMS.toolOffset?(POOLVR.config.toolOffset=new THREE.Vector3,POOLVR.config.toolOffset.fromArray(URL_PARAMS.toolOffset)):POOLVR.config.toolOffset=new THREE.Vector3(0,-.42,-POOLVR.config.toolLength-.15);var WebVRConfig=WebVRConfig||{};pyserver.log("WebVRConfig =\n"+JSON.stringify(WebVRConfig,void 0,2));var userAgent=navigator.userAgent;pyserver.log("userAgent = "+userAgent);var vrDevices=[];navigator.getVRDevices&&navigator.getVRDevices().then(function(a){a.forEach(function(a,b){pyserver.log("\nVR device "+b+": "+a.deviceName),console.log(a),vrDevices[b]=a})});var app,scene=CrapLoader.parse(JSON_SCENE),avatar=avatar||new THREE.Object3D;avatar.position.y=1.1,avatar.position.z=1.86;var textGeomLogger=new TextGeomLogger;avatar.add(textGeomLogger.root),textGeomLogger.root.position.set(-2.75,1.5,-3.5);var synthSpeaker=new SynthSpeaker({volume:.4,rate:.8,pitch:.5}),playCollisionSound=function(){"use strict";var a,b=new XMLHttpRequest;b.responseType="arraybuffer",b.open("GET","sounds/ballBall.ogg",!0),b.onload=function(){WebVRSound.audioContext.decodeAudioData(b.response,function(b){a=b})},b.send();var c=function(b){WebVRSound.playBuffer(a,Math.min(1,b/5))};return c}(),animate=function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(h){requestAnimationFrame(l);var n=.001*(h-v);v=h,app.vrControls.enabled&&app.vrControls.update(),app.vrManager.render(app.scene,app.camera,h),app.keyboard.update(n),app.gamepad.update(n);var o=app.keyboard.getValue("floatUp")+app.keyboard.getValue("floatDown"),w=app.keyboard.getValue("driveBack")+app.keyboard.getValue("driveForward"),x=app.keyboard.getValue("strafeRight")+app.keyboard.getValue("strafeLeft");if(s+=-.8*n*(app.keyboard.getValue("turnLeft")+app.keyboard.getValue("turnRight")),avatar.floatMode?(o+=app.gamepad.getValue("float"),x+=app.gamepad.getValue("strafe")):(w+=app.gamepad.getValue("drive"),s+=.8*n*app.gamepad.getValue("dheading")),o*=u,x||w){var y=t*Math.min(1,1/Math.sqrt(w*w+x*x));x*=y,w*=y}else x=0,w=0;var z=Math.cos(s),A=Math.sin(s),B=app.keyboard.getValue("moveToolForwards")-app.keyboard.getValue("moveToolBackwards"),C=app.keyboard.getValue("moveToolUp")-app.keyboard.getValue("moveToolDown"),D=app.keyboard.getValue("moveToolRight")-app.keyboard.getValue("moveToolLeft");D+=app.gamepad.getValue("toolStrafe"),avatar.toolMode?C+=app.gamepad.getValue("toolFloat"):B-=app.gamepad.getValue("toolDrive");var E=a.frame();E.valid&&E.id!=q&&(b(E,n),q=E.id),app.world.step(1/60,n);for(var F=0;F<c.length;++F){var G=c[F];G.mesh.position.copy(G.position)}for(F=0;F<d.length;F++){var H=d[F];H.quaternion.copy(H.parent.body.quaternion)}for(avatar.quaternion.setFromAxisAngle(r,s),avatar.position.x+=n*(x*z+w*A),avatar.position.z+=n*(w*z-x*A),avatar.position.y+=n*o,e.position.x+=.25*n*D,e.position.z+=-.25*n*B,e.position.y+=.25*n*C,f||(m.position.set(g.position.x,(i+.001-e.position.y-avatar.position.y)/e.scale.y,g.position.z),p.quaternion.copy(g.quaternion)),F=0;F<app.world.contacts.length;F++){var I=app.world.contacts[F],J=I.bi,K=I.bj;if(J.material===K.material){var L=I.getImpactVelocityAlongNormal();playCollisionSound(L)}else if(J.material===j||K.material===j){var M=J.material===k?J:K;M.bounces++,1===M.bounces||7===M.bounces&&M.sleep()}}}if(!f){var m=new THREE.Object3D;m.position.set(g.position.x,(i+.001-e.position.y-avatar.position.y)/e.scale.y,g.position.z),m.scale.set(1,.001,1),e.add(m);var n=new THREE.MeshBasicMaterial({color:8704}),o=g.geometry.clone(),p=new THREE.Mesh(o,n);p.quaternion.copy(g.quaternion),m.add(p)}var q,r=new THREE.Vector3(0,1,0),s=(new THREE.Vector3(1,0,0),0),t=(new THREE.Quaternion,.333),u=.1,v=0;new THREE.Raycaster;return l};