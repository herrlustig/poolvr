function addTool(a,b,c){"use strict";c=c||{};var d=c.toolLength||.5,e=c.toolRadius||.013,f=c.toolOffset||new THREE.Vector3(0,-.46,-d-.15),g=c.toolMass||.06,h=c.toolTime||.02,i=c.handOffset||new THREE.Vector3(0,-.25,-.4),j=c.minConfidence||.3,k=c.transformOptions||{},l=new THREE.Object3D;l.position.copy(f),a.add(l);var m=new THREE.CylinderGeometry(e,e,d,10,1,!1);m.translate(0,-d/2,0);var n,o;c.useBasicMaterials?(n=new THREE.MeshBasicMaterial({color:15645593,side:THREE.DoubleSide}),o=new THREE.MeshBasicMaterial({color:17544})):(n=new THREE.MeshLambertMaterial({color:15645593,side:THREE.DoubleSide}),o=new THREE.MeshLambertMaterial({color:17544}));var p=new THREE.Mesh(m,n);p.castShadow=!0,l.add(p);var q=new THREE.Mesh(new THREE.SphereBufferGeometry(e),o);q.castShadow=!0,p.add(q);var r=new CANNON.Body({mass:g,type:CANNON.Body.KINEMATIC});r.addShape(new CANNON.Sphere(e)),b.addBody(r);var s=new THREE.Object3D,t=new THREE.Object3D;s.position.copy(i),t.position.copy(i);var u=[s,t];if(a.add(s),a.add(t),s.visible=t.visible=!1,!c.leapHandsDisabled){var v=new THREE.MeshBasicMaterial({color:1127321,transparent:!0,opacity:0}),w=.0276,x=.26,y=new THREE.CylinderGeometry(w,w,x),z=new THREE.Mesh(y,v),A=[z,z.clone()];s.add(A[0]),t.add(A[1]);var B=.025,C=new THREE.SphereBufferGeometry(B).scale(1,.5,1),D=new THREE.Mesh(C,v);D.castShadow=!0;var E=[D,D.clone()];s.add(E[0]),t.add(E[1]),B=.005;var F=new THREE.SphereBufferGeometry(B),G=new THREE.Mesh(F,v),H=[[G,G.clone(),G.clone(),G.clone(),G.clone()],[G.clone(),G.clone(),G.clone(),G.clone(),G.clone()]];s.add(H[0][0],H[0][1],H[0][2],H[0][3],H[0][4]),t.add(H[1][0],H[1][1],H[1][2],H[1][3],H[1][4]);var I=G.clone();I.scale.set(1.4,1.4,1.4);var J=[[I,I.clone(),I.clone(),I.clone(),I.clone()],[I.clone(),I.clone(),I.clone(),I.clone(),I.clone()]];s.add(J[0][0],J[0][1],J[0][2],J[0][3],J[0][4]),t.add(J[1][0],J[1][1],J[1][2],J[1][3],J[1][4]);var K=G.clone();K.scale.set(1.1,1.1,1.1);var L=[[K,K.clone(),K.clone(),K.clone(),K.clone()],[K.clone(),K.clone(),K.clone(),K.clone(),K.clone()]];s.add(L[0][0],L[0][1],L[0][2],L[0][3],L[0][4]),t.add(L[1][0],L[1][1],L[1][2],L[1][3],L[1][4])}if(!c.leapDisabled){var M=new Leap.Controller({frameEventName:"animationFrame"});k.vr===!0&&(h*=2),console.log("'transform' options:"),console.log(k),M.use("transform",k).connect();var N=function(){var b=new THREE.Vector3(0,1,0),d=new THREE.Vector3,e=new THREE.Vector3,f=new THREE.Vector3;return c.leapHandsDisabled?function(c){if(1===c.tools.length){l.visible=!0;var g=c.tools[0];g.timeVisible>h&&(p.position.fromArray(g.tipPosition),d.fromArray(g.direction),p.quaternion.setFromUnitVectors(b,d),e.set(0,0,0),p.localToWorld(e),r.position.copy(e),f.set(.001*g.tipVelocity[0],.001*g.tipVelocity[1],.001*g.tipVelocity[2]),f.applyQuaternion(a.quaternion),r.velocity.copy(f))}else 2===c.tools.length&&console.log("TWO TOOLS OMG")}:function(c){if(1===c.tools.length){l.visible=!0;var g=c.tools[0];g.timeVisible>h&&(p.position.fromArray(g.tipPosition),d.fromArray(g.direction),p.quaternion.setFromUnitVectors(b,d),e.set(0,0,0),p.localToWorld(e),r.position.copy(e),f.set(.001*g.tipVelocity[0],.001*g.tipVelocity[1],.001*g.tipVelocity[2]),f.applyQuaternion(a.quaternion),r.velocity.copy(f))}else 2===c.tools.length&&console.log("TWO TOOLS OMG");s.visible=t.visible=!1;for(var i=0;i<c.hands.length;i++){var k=c.hands[i];if(k.confidence>j){u[i].visible=!0,v.opacity=k.confidence,d.fromArray(k.arm.basis[2]),A[i].quaternion.setFromUnitVectors(b,d);var m=k.arm.center();A[i].position.fromArray(m),d.fromArray(k.palmNormal),E[i].quaternion.setFromUnitVectors(b,d),E[i].position.fromArray(k.palmPosition);for(var n=0;n<k.fingers.length;n++){var o=k.fingers[n];H[i][n].position.fromArray(o.tipPosition),J[i][n].position.fromArray(o.bones[1].nextJoint),L[i][n].position.fromArray(o.bones[2].nextJoint)}}}}}();M.on("frame",N)}return[p,r,l]}function onLoad(){"use strict";if(pyserver.log("starting poolvr..."),pyserver.log("POOLVR.config =\n"+JSON.stringify(POOLVR.config)),POOLVR.config.keyboardCommands=POOLVR.keyboardCommands,POOLVR.config.gamepadCommands=POOLVR.gamepadCommands,app=new WebVRApplication("poolvr",avatar,scene,POOLVR.config),avatar.add(app.camera),scene.add(avatar),!app.config.useBasicMaterials){var a=new THREE.SpotLight(16777198,1,10,90);a.position.set(0,3,0),a.castShadow=!0,a.shadowCameraNear=.01,a.shadowCameraFar=4,a.shadowCameraFov=90,scene.add(a)}var b={transformOptions:{vr:"desktop"},leapDisabled:app.config.leapDisabled,leapHandsDisabled:app.config.leapHandsDisabled,useBasicMaterials:app.config.useBasicMaterials,toolLength:app.config.toolLength,toolRadius:app.config.toolRadius};app.config.leapVR&&(b.transformOptions={vr:!0,effectiveParent:app.camera}),CrapLoader.CANNONize(scene,app.world);var c=new CANNON.Material,d=new CANNON.ContactMaterial(c,c,{restitution:.91,friction:.08});app.world.addContactMaterial(d);var e=new CANNON.Material,f=new CANNON.ContactMaterial(c,e,{restitution:.3,friction:.1});app.world.addContactMaterial(f);var g=new CANNON.Material,h=new CANNON.ContactMaterial(c,g,{restitution:.8,friction:.18});app.world.addContactMaterial(h);var i=new CANNON.Material,j=new CANNON.ContactMaterial(i,c,{restitution:.88,friction:.4});app.world.addContactMaterial(j),scene.traverse(function(a){a.name.startsWith("ballMesh")?(a.body.material=c,ballMeshes.push(a)):a.name.startsWith("ballStripeMesh")?ballStripeMeshes.push(a):a.name.startsWith("playableSurfaceMesh")?a.body.material=e:a.name.endsWith("CushionMesh")?a.body.material=g:"floorMesh"===a.name&&(a.body.material=i)}),pyserver.log("adding tool..."),pyserver.log("toolOptions =\n"+JSON.stringify(b));var k=addTool(avatar,app.world,b);if(stickMesh=k[0],tipBody=k[1],toolRoot=k[2],!app.config.shadowMap){stickShadow=new THREE.Object3D,stickShadow.position.y=-avatar.position.y-toolRoot.position.y+H_table+.001,stickShadow.scale.set(1,4e-4,1),toolRoot.add(stickShadow);var l=stickMesh.geometry.clone(),m=b.toolLength;l.translate(0,-m/2,0);var n=new THREE.MeshBasicMaterial({color:8704});stickShadowMesh=new THREE.Mesh(l,n),stickShadowMesh.quaternion.copy(stickMesh.quaternion),stickShadow.add(stickShadowMesh)}if(app.config.mouseControlsEnabled){var o=stickMesh;o.position.y=H_table+.1-avatar.position.y-toolRoot.position.y,tipBody.position[1]=H_table+.1,window.addEventListener("mousemove",function(a){var b=a.movementX,c=a.movementY;o.position.x+=4e-4*b,o.position.x>2?o.position.x=2:o.position.x<-2&&(o.position.x=-2),o.position.z+=4e-4*c,o.position.z>2?o.position.z=2:o.position.z<-2&&(o.position.z=-2),tipBody.position[0]=o.position.x,tipBody.position[2]=o.position.z})}dynamicBodies=app.world.bodies.filter(function(a){return a.mesh&&a.type!==CANNON.Body.STATIC}),app.start(animate)}function animate(a){"use strict";requestAnimationFrame(animate);var b=.001*(a-app.lt);app.lt=a,app.vrControls.enabled&&app.vrControls.update(),app.vrManager.render(app.scene,app.camera,a),app.keyboard.update(b),app.gamepad.update(b),floatUp=app.keyboard.getValue("floatUp")+app.keyboard.getValue("floatDown"),drive=app.keyboard.getValue("driveBack")+app.keyboard.getValue("driveForward"),strafe=app.keyboard.getValue("strafeRight")+app.keyboard.getValue("strafeLeft"),avatar.heading+=-.8*b*(app.keyboard.getValue("turnLeft")+app.keyboard.getValue("turnRight")),avatar.floatMode?(floatUp+=app.gamepad.getValue("float"),strafe+=app.gamepad.getValue("strafe")):(drive+=app.gamepad.getValue("drive"),avatar.heading+=.8*b*app.gamepad.getValue("dheading"));var c=Math.cos(avatar.heading),d=Math.sin(avatar.heading);(!app.vrControls.enabled||app.config.vrPitchingEnabled)&&(kbpitch-=.8*b*(app.keyboard.getValue("pitchUp")+app.keyboard.getValue("pitchDown")),pitch=kbpitch,pitchQuat.setFromAxisAngle(RIGHT,pitch));Math.cos(pitch),Math.sin(pitch);if(floatUp*=floatSpeed,strafe||drive){var e=walkSpeed*Math.min(1,1/Math.sqrt(drive*drive+strafe*strafe));strafe*=e,drive*=e}else strafe=0,drive=0;toolDrive=app.keyboard.getValue("moveToolForwards")-app.keyboard.getValue("moveToolBackwards"),toolFloat=app.keyboard.getValue("moveToolUp")-app.keyboard.getValue("moveToolDown"),toolStrafe=app.keyboard.getValue("moveToolRight")-app.keyboard.getValue("moveToolLeft"),toolStrafe+=app.gamepad.getValue("toolStrafe"),avatar.toolMode?toolFloat+=app.gamepad.getValue("toolFloat"):toolDrive-=app.gamepad.getValue("toolDrive"),app.world.step(Math.min(b,1/60));for(var f=0;f<dynamicBodies.length;++f){var g=dynamicBodies[f];g.mesh.position.copy(g.position)}for(f=0;f<ballStripeMeshes.length;f++){var h=ballStripeMeshes[f];h.quaternion.copy(h.parent.body.quaternion)}if(avatar.quaternion.setFromAxisAngle(UP,avatar.heading),avatar.quaternion.multiply(pitchQuat),avatar.position.x+=b*(strafe*c+drive*d),avatar.position.z+=b*(drive*c-strafe*d),avatar.position.y+=b*floatUp,toolRoot.position.x+=.25*b*toolStrafe,toolRoot.position.z+=-.25*b*toolDrive,toolRoot.position.y+=.25*b*toolFloat,app.config.shadowMap||(stickShadow.position.x=stickMesh.position.x,stickShadow.position.z=stickMesh.position.z,stickShadow.position.y=-avatar.position.y-toolRoot.position.y+H_table+.001,stickShadowMesh.quaternion.copy(stickMesh.quaternion)),app.mousePointer&&avatar.picking){origin.set(0,0,0),direction.set(0,0,0),direction.subVectors(mousePointer.localToWorld(direction),camera.localToWorld(origin)).normalize(),raycaster.set(origin,direction);var i=raycaster.intersectObjects(app.pickables);i.length>0?app.picked!=i[0].object&&(app.picked&&app.picked.material.color.setHex(app.picked.currentHex),app.picked=i[0].object,app.picked.currentHex=app.picked.material.color.getHex(),app.picked.material.color.setHex(16729156)):(app.picked&&app.picked.material.color.setHex(app.picked.currentHex),app.picked=null)}}WebVRApplication=function(){function a(a,b,c,d){function e(){document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement?(d.showMousePointerOnLock&&(mousePointer.visible=!0),mousePointer.position.x=mousePointer.position.y=0):(console.log("pointer lock status is now unlocked"),mousePointer.visible=!1)}this.name=a,this.avatar=b,this.scene=c,this.config=d,this.avatar.heading=0;var f=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);this.camera=f;var g=new THREE.WebGLRenderer({antialias:!0,alpha:!0});this.renderer=g,this.renderer.setPixelRatio(window.devicePixelRatio),void 0!==d.backgroundColor&&this.renderer.setClearColor(d.backgroundColor),this.renderer.setSize(window.innerWidth,window.innerHeight),d.shadowMap&&(console.log("shadow mapping enabled"),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap),document.body.appendChild(this.renderer.domElement),this.vrEffect=new THREE.VREffect(this.renderer),this.vrManager=new WebVRManager(this.renderer,this.vrEffect,{hideButton:!1}),this.vrControls=new THREE.VRControls(this.camera),this.vrControls.enabled=!1,this.resetVRSensor=function(){this.vrControls.resetSensor(),this.avatar.heading=0}.bind(this);var h=new THREE.MeshBasicMaterial({color:15654314,wireframe:!0});this.toggleWireframe=function(){this.scene.overrideMaterial?(console.log("wireframe: off"),this.scene.overrideMaterial=null):(console.log("wireframe: on"),this.scene.overrideMaterial=h)}.bind(this),this.toggleVRControls=function(){this.vrControls.enabled?(this.vrControls.enabled=!1,this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1)):(this.vrControls.enabled=!0,this.vrControls.update())}.bind(this);var i={toggleVRControls:{buttons:[Primrose.Input.Keyboard.V],commandDown:this.toggleVRControls.bind(this),dt:.25},toggleWireframe:{buttons:[Primrose.Input.Keyboard.NUMBER0],commandDown:this.toggleWireframe.bind(this),dt:.25},resetVRSensor:{buttons:[Primrose.Input.Keyboard.Z],commandDown:this.resetVRSensor.bind(this),dt:.25}};d.keyboardCommands=combineDefaults(d.keyboardCommands||{},i),d.keyboardCommands=Object.keys(d.keyboardCommands).map(function(a){return combineDefaults({name:a},d.keyboardCommands[a])}),this.keyboard=new Primrose.Input.Keyboard("keyboard",window,d.keyboardCommands);var j={resetVRSensor:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.back],commandDown:this.resetVRSensor.bind(this),dt:.25}};d.gamepadCommands=combineDefaults(d.gamepadCommands||{},j),d.gamepadCommands=Object.keys(d.gamepadCommands).map(function(a){return combineDefaults({name:a},d.gamepadCommands[a])}),this.gamepad=new Primrose.Input.Gamepad("gamepad",d.gamepadCommands),this.gamepad.addEventListener("gamepadconnected",function(a){this.gamepad.isGamepadSet()||(this.gamepad.setGamepad(a),console.log("gamepad "+a+" connected"))}.bind(this),!1),this.listeners={update:[]};var k=new CANNON.World;k.gravity.set(0,-d.gravity,0),k.broadphase=new CANNON.SAPBroadphase(k),k.defaultContactMaterial.contactEquationStiffness=1e8,k.defaultContactMaterial.frictionEquationStiffness=1e8,k.defaultContactMaterial.contactEquationRelaxation=3,k.defaultContactMaterial.frictionEquationRelaxation=3,k.solver.iterations=10,this.world=k,window.addEventListener("resize",function(){var a=window.innerWidth,b=window.innerHeight;this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.vrManager.isVRMode()&&(this.vrControls.enabled=!0)}.bind(this),!1),d.mouseControlsEnabled&&("onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document?document.addEventListener("mozpointerlockchange",e,!1):"onwebkitpointerlockchange"in document&&document.addEventListener("webkitpointerlockchange",e,!1)),this.lt=0,this.start=function(a){function b(d){if(CrapLoader.isLoaded()){CrapLoader.CANNONize(c,k);for(var e=0;480>e;e++)k.step(1/240);this.lt=d,requestAnimationFrame(a)}else requestAnimationFrame(b)}b(0)},this.audioContext=new AudioContext;var l=this.audioContext,m=l.createGain();m.connect(l.destination),m.gain.value=1,this.gainNode=m,this.playSound=function(a,b){var c=l.createBufferSource();c.loop=b===!0,c.connect(m);var d=new XMLHttpRequest;d.responseType="arraybuffer",d.open("GET",a,!0),d.onload=function(){l.decodeAudioData(d.response).then(function(a){c.buffer=a,c.start(0)})},d.send()}}return a}();var CrapLoader=function(){"use strict";function a(){return e}function b(a){function b(a){a.traverse(function(a){a instanceof THREE.Mesh&&(a.geometry.computeBoundingSphere(),a.geometry.computeBoundingBox(),a.userData&&a.userData.visible===!1&&(a.visible=!1),a.geometry.computeVertexNormals(),a.material.shading===THREE.FlatShading&&a.geometry.computeFaceNormals())})}a.materials&&a.materials.forEach(function(a){if(a.type.endsWith("ShaderMaterial")&&a.uniforms){var b=a.uniforms;for(var c in b){var d=b[c];"t"===d.type&&(Array.isArray(d.value)&&6==d.value.length?(e=!1,d.value=h.load(d.value)):"string"==typeof d.value&&(e=!1,d.value=g.load(d.value)))}}});var c=f.parseGeometries(a.geometries.filter(function(a){return"TextGeometry"!=a.type}));a.geometries.forEach(function(a){if("TextGeometry"==a.type){var b=new THREE.TextGeometry(a.text,a.parameters);b.uuid=a.uuid,void 0!==a.name&&(b.name=a.name),c[a.uuid]=b}});var d=f.parseImages(a.images,function(){b(k)}),i=f.parseTextures(a.textures,d),j=f.parseMaterials(a.materials,i),k=f.parseObject(a.object,c,j);return(void 0===a.images||0===a.images.length)&&b(k),k}function c(a,b){function c(a,b){var d,e;if(a.body)return a.body;if(a instanceof THREE.Mesh){i.copy(a.position);var f={mass:b.mass,position:a.localToWorld(i),quaternion:a.quaternion};return void 0!==b.linearDamping&&(f.linearDamping=b.linearDamping),void 0!==b.angularDamping&&(f.angularDamping=b.angularDamping),d=new CANNON.Body(f),d.mesh=a,b.shapes.forEach(function(b){var c,e,f,g;switch(b){case"Plane":c=new CANNON.Plane,f=new CANNON.Quaternion,f.setFromEuler(-Math.PI/2,0,0,"XYZ");break;case"Box":var h=new CANNON.Vec3;a.geometry.computeBoundingBox(),h.x=a.scale.x*(a.geometry.boundingBox.max.x-a.geometry.boundingBox.min.x)/2,h.y=a.scale.y*(a.geometry.boundingBox.max.y-a.geometry.boundingBox.min.y)/2,h.z=a.scale.z*(a.geometry.boundingBox.max.z-a.geometry.boundingBox.min.z)/2,c=new CANNON.Box(h);break;case"Sphere":a.geometry.computeBoundingSphere(),c=new CANNON.Sphere(a.geometry.boundingSphere.radius);break;case"ConvexPolyhedron":var i=[],j=[];if(a.geometry instanceof THREE.BufferGeometry){g=a.geometry.getAttribute("position").array;for(var k=0;k<g.length;k+=3)i.push(new CANNON.Vec3(g[k],g[k+1],g[k+2]));for(g=a.geometry.index.array,k=0;k<g.length;k+=3){var l=[g[k],g[k+1],g[k+2]];j.push(l)}}else a.geometry instanceof THREE.Geometry;c=new CANNON.ConvexPolyhedron(i,j);break;case"Cylinder":c=new CANNON.Cylinder(a.geometry.parameters.radiusTop,a.geometry.parameters.radiusBottom,a.geometry.parameters.height,a.geometry.parameters.radialSegments);break;default:console.log("unknown shape type: "+b)}d.addShape(c,e,f)}),a.body=d,d}return a instanceof THREE.Object3D?(e=[],a.children.forEach(function(a){e.push(c(a,b))}),e):void console.log("makeCANNON error")}a.traverse(function(a){if(a.userData&&a.userData.cannonData){var d=c(a,a.userData.cannonData);b&&(d instanceof CANNON.Body?b.addBody(d):d.forEach(function(a){b.addBody(a)}))}})}var d=new THREE.LoadingManager,e=!0;d.onLoad=function(){e=!0};var f=new THREE.ObjectLoader(d),g=(new THREE.ImageLoader(d),new THREE.TextureLoader(d)),h=new THREE.CubeTextureLoader(d),i=new THREE.Vector3;return{parse:b,CANNONize:c,isLoaded:a}}(),avatar=avatar||new THREE.Object3D,TextGeomLogger=function(){"use strict";function a(a,b,c){this.geometries=geomeries,this.material=b,this.meshes={};for(var d in this.geometries){var e=this.geometries[d].clone();this.meshes[d]=new THREE.Mesh(e,b.clone())}this.logRoot=new THREE.Object3D,this.lineMeshBuffer={},c=c||{},c.size=c.size||.2,c.font="anonymous pro",c.height=c.height||0,c.rows=c.rows||20,c.columns=c.columns||80,c.parent=c.parent||avatar,this.options=c,this.log=function(a){for(var b=a.split("\n"),c=0;c<b.length&&c<this.logRoot.children.length;c++){var d=this.logRoot.children[c];d.position.y+=1.6*this.options.size}for(c=0;c<b.length;c++){var e=b[c],f=this.lineMeshBuffer[e];if(f)this.logRoot.add(f.clone());else{f=new THREE.Object3D,this.logRoot.add(f),this.lineMeshBuffer[e]=f;for(var g=0;g<e.length;g++){var h=e[g];if(" "!==h){var i=this.meshes[h].clone();i.position.x=1.6*this.options.size*g}}}}}.bind(this)}return a}(),pyserver;pyserver=POOLVR_CONFIG.pyserver?{log:function(a,b){"use strict";var c=new XMLHttpRequest,d=new FormData;d.append("msg",a),c.open("POST","/log"),c.onload=function(){var a=JSON.parse(c.responseText);b&&b(a)},c.send(d)},readFile:function(a,b,c){"use strict";var d=new XMLHttpRequest;d.open("GET","/read?file="+a),d.onload=function(){var a=JSON.parse(d.responseText);a.text?b(a.text):a.error&&(console.log(a.error),c&&c.log(a.error))},d.send()},writeFile:function(a,b){"use strict";var c=new XMLHttpRequest;if(c.open("POST","/write?file="+a),c.onload=function(){var a=JSON.parse(c.responseText);a.filename?console.log("wrote "+a.filename):a.error&&console.log(a.error)},"string"==typeof b){var d=new FormData;d.append("text",b),c.send(d)}else c.setRequestHeader("Content-Type","application/json"),c.send(JSON.stringify(b))}}:{log:function(a){console.log("pyserver.log: "+a)},readFile:function(){},writeFile:function(){}};var URL_PARAMS=function(){"use strict";var a={};location.search.substr(1).split("&").forEach(function(b){var c=b.split("=")[0],d=decodeURIComponent(b.split("=")[1]);c in a?a[c].push(d):a[c]=[d]});for(var b in a)1==a[b].length&&(a[b]=a[b][0]),"true"===a[b]?a[b]=!0:"false"===a[b]&&(a[b]=!1);return a}(),POOLVR_VERSION=POOLVR_VERSION||"poolvr-0.1.0",POOLVR={config:POOLVR_CONFIG,version:POOLVR_VERSION};POOLVR.keyboardCommands={turnLeft:{buttons:[-Primrose.Input.Keyboard.LEFTARROW]},turnRight:{buttons:[Primrose.Input.Keyboard.RIGHTARROW]},driveForward:{buttons:[-Primrose.Input.Keyboard.W]},driveBack:{buttons:[Primrose.Input.Keyboard.S]},strafeLeft:{buttons:[-Primrose.Input.Keyboard.A]},strafeRight:{buttons:[Primrose.Input.Keyboard.D]},floatUp:{buttons:[Primrose.Input.Keyboard.E,Primrose.Input.Keyboard.NUMBER9]},floatDown:{buttons:[-Primrose.Input.Keyboard.C,-Primrose.Input.Keyboard.NUMBER3]},moveToolUp:{buttons:[Primrose.Input.Keyboard.NUMBER7]},moveToolDown:{buttons:[Primrose.Input.Keyboard.NUMBER1]},moveToolForwards:{buttons:[Primrose.Input.Keyboard.NUMBER8]},moveToolBackwards:{buttons:[Primrose.Input.Keyboard.NUMBER5]},moveToolLeft:{buttons:[Primrose.Input.Keyboard.NUMBER4]},moveToolRight:{buttons:[Primrose.Input.Keyboard.NUMBER6]}};var DEADZONE=.2;POOLVR.gamepadCommands={strafe:{axes:[Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},drive:{axes:[Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},dheading:{axes:[-Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},pitch:{axes:[Primrose.Input.Gamepad.LSY],integrate:!0,deadzone:DEADZONE,max:.5*Math.PI,min:-.5*Math.PI},"float":{axes:[-Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},toggleFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.leftStick],commandDown:function(){avatar.floatMode=!0},commandUp:function(){avatar.floatMode=!1}},toolStrafe:{axes:[Primrose.Input.Gamepad.RSX],deadzone:DEADZONE},toolDrive:{axes:[Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toolFloat:{axes:[-Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toggleToolFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.rightStick],commandDown:function(){avatar.toolMode=!0},commandUp:function(){avatar.toolMode=!1}}},POOLVR.config.oldBoilerplate?window.WEBVR_FORCE_DISTORTION=window.WEBVR_FORCE_DISTORTION||URL_PARAMS.forceDistorion:window.WebVRConfig=window.WebVRConfig||{FORCE_ENABLE_VR:URL_PARAMS.forceEnableVR,FORCE_DISTORTION:URL_PARAMS.forceDistortion};var VR_DEVICES=["Phone Sensor (Cardboard) HMD (HMD)","Phone Sensor (Cardboard) HMD (Sensor)","Google, Inc. Cardboard v1","Google, Inc. Cardboard v1","webvr-polyfill deviceName","VR Position Device (webvr-polyfill:fused)","Oculus Rift DK2, Oculus VR","Oculus Rift DK2, Oculus VR","Oculus VR HMD (HMD)","Oculus VR HMD (Sensor)"];pyserver.log(JSON.stringify(WebVRConfig));var userAgent=navigator.userAgent;pyserver.log(userAgent),navigator.getVRDevices&&navigator.getVRDevices().then(function(a){a.forEach(function(a,b){pyserver.log("VR device "+b+": "+a.deviceName)})});var app,scene=CrapLoader.parse(JSON_SCENE),avatar=avatar||new THREE.Object3D,H_table=.74295;avatar.position.y=1.2,avatar.position.z=1.9;var stickMesh,tipBody,toolRoot,stickShadow,stickShadowMesh,ballMeshes=[],ballStripeMeshes=[],dynamicBodies,UP=new THREE.Vector3(0,1,0),RIGHT=new THREE.Vector3(1,0,0),pitch=0,pitchQuat=new THREE.Quaternion,headingQuat=new THREE.Quaternion,strafe,drive,floatUp,kbpitch=0,walkSpeed=.3,floatSpeed=.1,toolDrive,toolStrafe,toolFloat,raycaster=new THREE.Raycaster;