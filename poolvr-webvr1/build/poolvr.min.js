/* ############################################################################

  poolvr v0.1.0 2016-03-04

  https://jzitelli.github.io/poolvr
  git+https://github.com/jzitelli/poolvr.git

The MIT License (MIT)

Copyright (c) 2015 Jeffrey Zitelli

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

############################################################################ */

function WebVRApplication(a,b){"use strict";this.scene=a,b=b||{};var c,d=b.rendererOptions,e=b.useShadowMap,f=b.onResetVRSensor,g=b.devicePixelRatio||window.devicePixelRatio;b.canvasId?(c=document.getElementById(b.canvasId),d=combineObjects(d,{canvas:c}),this.renderer=new THREE.WebGLRenderer(d)):(this.renderer=new THREE.WebGLRenderer(d),c=this.renderer.domElement,document.body.appendChild(c),c.id="webgl-canvas"),this.renderer.setPixelRatio(g),this.renderer.setSize(window.innerWidth,window.innerHeight),e&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap),this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.matrixAutoUpdate=!0,this.vrEffect=new THREE.VREffect(this.renderer,function(a){console.error("error creating VREffect: "+a)}),this.vrControls=new THREE.VRControls(this.camera,function(a){console.error("error creating VRControls: "+a)}),this.vrControlsEnabled=!0,this.render=function(){this.vrControlsEnabled&&this.vrControls.update(),this.vrEffect.render(this.scene,this.camera)}.bind(this),this.toggleVRControls=function(){this.vrControlsEnabled?(this.vrControlsEnabled=!1,this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.camera.updateMatrixWorld()):this.vrControlsEnabled=!0}.bind(this);var h=new THREE.Vector3;this.resetVRSensor=function(){if(this.vrControlsEnabled){h.copy(this.camera.position);var a=this.camera.rotation.y;this.vrControls.resetSensor(),this.vrControls.update(),f&&f(a,h)}}.bind(this);var i=new THREE.MeshBasicMaterial({color:15654314,wireframe:!0});this.toggleWireframe=function(){this.scene.overrideMaterial?this.scene.overrideMaterial=null:this.scene.overrideMaterial=i}.bind(this);var j=!1;if(window.addEventListener("resize",function(){j||(this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight))}.bind(this),!1),window.VRDisplay||window.HMDVRDevice){var k=document.createElement("button");k.innerHTML="ENTER VR",k.style.position="absolute",k.style.right=0,k.style.bottom=0,k.style.margin="10px",k.style.padding="10px",k.style.background=2236962,k.style["text-color"]=16777215;var l=function(){j?this.vrEffect.exitPresent().then(function(){j=!1,k.innerHTML="ENTER VR",this.renderer.setSize(window.innerWidth,window.innerHeight)}.bind(this)):this.vrEffect.requestPresent().then(function(){j=!0,k.innerHTML="EXIT VR"})["catch"](function(a){console.error(a),k.innerHTML="VR ERROR!",k.style.background=10035746,k.removeEventListener("click",l)})}.bind(this);k.addEventListener("click",l,!1),document.body.appendChild(k)}else console.warn("WebVR is not supported on your browser / platform")}function combineObjects(a,b){"use strict";var c,d={};for(c in a)d[c]=a[c];for(c in b)d.hasOwnProperty(c)||(d[c]=b[c]);return d}function makeObjectArray(a,b){"use strict";return b=b||"key",Object.keys(a).map(function(c){var d={};d[b]=c;for(var e in a[c])d[e]=a[c][e];return d})}function isMobile(){var a=navigator.userAgent||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))}function addTool(a,b,c){"use strict";function d(){O.position.copy(T.interpolatedPosition),O.position.applyMatrix4(h.matrixWorldInverse),O.updateMatrix(),O.updateMatrixWorld(),Q||(P.updateMatrix(),P.updateMatrixWorld())}function e(b,c,d){var e=0,f=0,g=0,i=0;b&&(e+=b.getValue("moveToolForwards")-b.getValue("moveToolBackwards"),f+=b.getValue("moveToolUp")-b.getValue("moveToolDown"),g+=b.getValue("moveToolRight")-b.getValue("moveToolLeft"),i+=b.getValue("rotateToolCW")-b.getValue("rotateToolCCW")),c&&(a.toolMode?(f+=c.getValue("toolFloat"),g+=c.getValue("toolStrafe")):(e-=c.getValue("toolDrive"),i-=c.getValue("toolStrafe"))),0===e&&0===g&&0===f&&0===i||(h.position.x+=.16*d*g,h.position.z+=-.16*d*e,h.position.y+=.16*d*f,h.rotation.y-=.15*d*i,h.updateMatrix(),h.updateMatrixWorld(),h.matrixWorldInverse.getInverse(h.matrixWorld),h.matrixWorld.decompose(h.worldPosition,h.worldQuaternion,h.worldScale),Q||(P.updateMatrix(),P.updateMatrixWorld()),C.visible===!1&&(C.visible=!0,D.opacity=r))}function f(){var a=x.frame();if(a.valid&&a.id!=ra){ra=a.id;var b=a.interactionBox;if(b.valid&&(C.position.fromArray(b.center),C.scale.set(b.width*i,b.height*i,b.depth*i),C.updateMatrix(),C.updateMatrixWorld()),1===a.tools.length){var c=a.tools[0];(O.visible===!1||O.material.opacity<1)&&(O.visible=!0,Q||(P.visible=!0),O.material.opacity=1,U&&(U.material.opacity=1),C.visible=!0,D.opacity=r),ta.fromArray(c.stabilizedTipPosition),sa.fromArray(c.direction),O.position.copy(ta),ta.applyMatrix4(h.matrixWorld),T.position.copy(ta),O.quaternion.setFromUnitVectors(g,sa),va.multiplyQuaternions(h.worldQuaternion,O.quaternion),T.quaternion.copy(va),O.updateMatrix(),O.updateMatrixWorld(),Q||(P.updateMatrix(),P.updateMatrixWorld()),ua.fromArray(c.tipVelocity),ua.applyQuaternion(h.worldQuaternion),ua.multiplyScalar(i),T.velocity.copy(ua),c.timeVisible>p&&(T.sleepState===CANNON.Body.SLEEPING&&(T.wakeUp(),U&&U.material.color.setHex(16711680)),c.timeVisible>q&&D.opacity>.1&&(D.opacity*=.93))}else T.sleepState===CANNON.Body.AWAKE?(T.sleep(),U&&U.material.color.setHex(t)):O.visible&&O.material.opacity>.1?(O.material.opacity*=.8,D.opacity*=.8,U&&(U.material.opacity=O.material.opacity)):(O.visible=!1,C.visible=!1,Q||(P.visible=!1))}}c=c||{};var g=THREE.Object3D.DefaultUp,h=new THREE.Object3D,i=.001,j=1e3;h.scale.set(i,i,i),a.add(h),h.quaternion.setFromAxisAngle(g,c.toolRotation||0),h.position.fromArray(c.toolOffset||[0,-.42,-.42]);var k,l=c.toolLength||.5,m=c.toolRadius||.013,n=c.toolMass||.04,o=c.tipShape||"Cylinder";k="Cylinder"===o?c.tipRadius||m:c.tipRadius||.95*m;var p=c.toolTimeA||.25,q=c.toolTimeB||p+1.5,r=(c.minConfidence||.3,c.interactionPlaneOpacity||.23),s=c.stickColor||15645593,t=c.tipColor||17544,u=c.handColor||1127321,v=c.host||"127.0.0.1",w=c.port||6437,x=new Leap.Controller({background:!0,host:v,port:w}),y=c.onConnect||function(){console.log("Leap Motion WebSocket connected")};x.on("connect",y);var z=c.onDisconnect||function(){console.log("Leap Motion WebSocket disconnected")};x.on("disconnect",z);var A=c.onStreamingStarted||function(){console.log("Leap Motion streaming started")};x.on("streamingStarted",A);var B=c.onStreamingStopped||function(){console.warn("Leap Motion streaming stopped")};x.on("streamingStopped",B),x.connect();var C=new THREE.Object3D;h.add(C);var D=new THREE.MeshBasicMaterial({color:56644,transparent:!0,opacity:r}),E=new THREE.PlaneBufferGeometry(j,j),F=new THREE.Mesh(E,D);C.add(F),F=F.clone(),F.position.z=.5*j,F.updateMatrix(),C.add(F),F=F.clone(),F.position.z=j*-.5,F.updateMatrix(),C.add(F);var G=.0254,H=new THREE.BoxGeometry(j*G*3,j*G*.5,j*G*1.2),I=new THREE.BufferGeometry;I.fromGeometry(H),H.dispose();var J=new THREE.MeshLambertMaterial({color:7829367}),K=new THREE.Mesh(I,J);K.position.y=j*G*.25,K.updateMatrix(),h.add(K);var L=new THREE.CylinderGeometry(j*m,j*m,j*l,10,1,!1);L.translate(0,-.5*j*l,0);var M=new THREE.BufferGeometry;M.fromGeometry(L),L.dispose(),L=M;var N=new THREE.MeshLambertMaterial({color:s,side:THREE.DoubleSide,transparent:!0}),O=new THREE.Mesh(L,N);O.castShadow=!0,h.add(O);var P,Q=POOLVR.config.useShadowMap;if(!Q){P=new THREE.ShadowMesh(O),POOLVR.app.scene.add(P);var R=new THREE.Plane(g,POOLVR.config.H_table+.001),S=new THREE.Vector4(0,5,0,.01);P.updateShadowMatrix(R,S)}var T=new CANNON.Body({mass:n,type:CANNON.Body.KINEMATIC});T.material=POOLVR.tipMaterial;var U=null;if("Cylinder"!==o){var V=new THREE.SphereBufferGeometry(j*k,10);T.addShape(new CANNON.Sphere(k));var W=new THREE.MeshLambertMaterial({color:t,transparent:!0});U=new THREE.Mesh(V,W),U.castShadow=!0,O.add(U)}else{var X=new CANNON.Quaternion;X.setFromEuler(-Math.PI/2,0,0,"XYZ");var Y=new CANNON.Vec3(0,-k,0);T.addShape(new CANNON.Cylinder(k,k,2*k,8),Y,X)}b.addBody(T);var Z=new THREE.Object3D,$=new THREE.Object3D;h.add(Z),h.add($);var _=new THREE.MeshBasicMaterial({color:u,transparent:!0,opacity:0}),aa=.0216*j,ba=.22*j,ca=new THREE.CylinderGeometry(aa,aa,ba);M=new THREE.BufferGeometry,M.fromGeometry(ca),ca.dispose(),ca=M;var da=new THREE.Mesh(ca,_),ea=[da,da.clone()];Z.add(ea[0]),$.add(ea[1]);var fa=.025*j,ga=new THREE.SphereBufferGeometry(fa).scale(1,.5,1),ha=new THREE.Mesh(ga,_);ha.castShadow=!0;var ia=[ha,ha.clone()];Z.add(ia[0]),$.add(ia[1]),fa=.005*j;var ja=new THREE.SphereBufferGeometry(fa),ka=new THREE.Mesh(ja,_),la=[[ka,ka.clone(),ka.clone(),ka.clone(),ka.clone()],[ka.clone(),ka.clone(),ka.clone(),ka.clone(),ka.clone()]];Z.add(la[0][0],la[0][1],la[0][2],la[0][3],la[0][4]),$.add(la[1][0],la[1][1],la[1][2],la[1][3],la[1][4]);var ma=ka.clone();ma.scale.set(1.4,1.4,1.4);var na=[[ma,ma.clone(),ma.clone(),ma.clone(),ma.clone()],[ma.clone(),ma.clone(),ma.clone(),ma.clone(),ma.clone()]];Z.add(na[0][0],na[0][1],na[0][2],na[0][3],na[0][4]),$.add(na[1][0],na[1][1],na[1][2],na[1][3],na[1][4]);var oa=ka.clone();oa.scale.set(1.1,1.1,1.1);var pa=[[oa,oa.clone(),oa.clone(),oa.clone(),oa.clone()],[oa.clone(),oa.clone(),oa.clone(),oa.clone(),oa.clone()]];Z.add(pa[0][0],pa[0][1],pa[0][2],pa[0][3],pa[0][4]),$.add(pa[1][0],pa[1][1],pa[1][2],pa[1][3],pa[1][4]),h.updateMatrix(),h.updateMatrixWorld(),Q||(P.updateMatrix(),P.updateMatrixWorld(),P.visible=!1),h.worldPosition=new THREE.Vector3,h.worldQuaternion=new THREE.Quaternion,h.worldScale=new THREE.Vector3,h.matrixWorld.decompose(h.worldPosition,h.worldQuaternion,h.worldScale),h.matrixWorldInverse=new THREE.Matrix4,h.matrixWorldInverse.getInverse(h.matrixWorld),C.visible=!1,O.visible=!1,Z.visible=!1,$.visible=!1;var qa=0;T.addEventListener(CANNON.Body.COLLIDE_EVENT_NAME,function(a){qa++,1===qa?setTimeout(function(){POOLVR.synthSpeaker.speak("You moved a ball.  Good job.")},250):16===qa&&setTimeout(function(){POOLVR.synthSpeaker.speak("You are doing a great job.")},3e3)});var ra,sa=new THREE.Vector3,ta=new THREE.Vector3,ua=new THREE.Vector3,va=new THREE.Quaternion;return{toolRoot:h,leapController:x,updateTool:f,updateToolPostStep:d,moveToolRoot:e}}function onLoad(){"use strict";POOLVR.config=POOLVR.loadConfig(POOLVR.profile)||POOLVR.config,POOLVR.parseURIConfig(),console.log("POOLVR.config =\n"+JSON.stringify(POOLVR.config,void 0,2)),THREE.Object3D.DefaultMatrixAutoUpdate=!1,POOLVR.avatar=new THREE.Object3D;var a=POOLVR.avatar;if(a.position.fromArray(POOLVR.config.initialPosition),a.heading=0,a.floatMode=!1,a.toolMode=!1,POOLVR.synthSpeaker=new SynthSpeaker({volume:POOLVR.config.synthSpeakerVolume,rate:.8,pitch:.5}),POOLVR.config.useTextGeomLogger){var b=new THREE.FontLoader;b.load("fonts/Anonymous Pro_Regular.js",function(b){var c=new TextGeomUtils.TextGeomCacher(b,{size:.14}),d=new THREE.MeshBasicMaterial({color:16724496});POOLVR.textGeomLogger=new TextGeomUtils.TextGeomLogger(c,{material:d,nrows:7,lineHeight:1.8*.14}),a.add(POOLVR.textGeomLogger.root),POOLVR.textGeomLogger.root.position.set(-2.7,.88,-3.3),POOLVR.textGeomLogger.root.updateMatrix()})}else POOLVR.textGeomLogger={root:new THREE.Object3D,log:function(a){console.log(a)},clear:function(){}};THREE.py.parse(THREEPY_SCENE).then(function(b){b.autoUpdate=!1;var c=new THREE.SpotLight(16777198,1,8,Math.PI/2);if(c.position.set(0,3,0),c.castShadow=!0,c.shadow.camera.matrixAutoUpdate=!0,c.shadow.camera.near=1,c.shadow.camera.far=3,c.shadow.camera.fov=80,b.add(c),c.updateMatrix(),c.updateMatrixWorld(),POOLVR.centerSpotLight=c,POOLVR.config.usePointLight){var d=new THREE.PointLight(11176038,.8,40);d.position.set(4,5,2.5),b.add(d),d.updateMatrix(),d.updateMatrixWorld()}var e=combineObjects(POOLVR.config,{canvasId:"webgl-canvas",onResetVRSensor:function(b,c){var d=POOLVR.app.camera;POOLVR.toolRoot.rotation.y-=b-d.rotation.y,POOLVR.toolRoot.position.sub(c),POOLVR.toolRoot.position.applyAxisAngle(THREE.Object3D.DefaultUp,-b+d.rotation.y),POOLVR.toolRoot.position.add(d.position),POOLVR.avatar.heading+=b-d.rotation.y,POOLVR.avatar.quaternion.setFromAxisAngle(THREE.Object3D.DefaultUp,a.heading),POOLVR.avatar.updateMatrix(),POOLVR.avatar.updateMatrixWorld()}});POOLVR.app=new WebVRApplication(b,e),a.add(POOLVR.app.camera),b.add(a),a.updateMatrix(),a.updateMatrixWorld(),POOLVR.setupMenu(),POOLVR.setup(),POOLVR.switchMaterials(POOLVR.config.useBasicMaterials),b.updateMatrixWorld(!0),POOLVR.startAnimateLoop()})}THREE.py=function(){"use strict";function a(a,c){function d(a){function b(a,b,c){var d=4*(b+a.width*c),e=a.data;return{r:e[d],g:e[d+1],b:e[d+2],a:e[d+3]}}a.traverse(function(a){if(a.userData&&a.userData.heightfieldImage){var c=a.userData.heightfieldImage,d=a.userData.heightfieldScale||1,f=e[c];if(f){var g=document.createElement("canvas");g.width=f.width,g.height=f.height;var h=g.getContext("2d");h.drawImage(f,0,0);for(var i=h.getImageData(0,0,f.width,f.height),j=a.geometry.getAttribute("position"),k=a.geometry.parameters.widthSegments+1,l=a.geometry.parameters.heightSegments+1,m=0,n=0;l>n;++n)for(var o=0;k>o;++o){var p=b(i,o,n);j.setZ(m++,d*(p.r+256*p.g+65536*p.b)/16777216)}j.needsUpdate=!0,a.geometry.computeFaceNormals(),a.geometry.computeVertexNormals(),a.geometry.normalsNeedUpdate=!0,a.geometry.computeBoundingSphere(),a.geometry.computeBoundingBox()}}})}var e,f=new THREE.ObjectLoader,g=new THREE.LoadingManager,h=new THREE.TextureLoader(g),i=new THREE.CubeTextureLoader(g),j=new THREE.FontLoader(g),k=new Promise(function(k,l){function m(){function g(a){a.traverse(function(a){a.updateMatrix(),a.userData&&a.userData.layers&&a.userData.layers.forEach(function(b){a.layers.set(b)}),a instanceof THREE.Mesh&&(a.geometry.computeBoundingSphere(),a.geometry.computeBoundingBox(),a.material.shading===THREE.FlatShading&&a.geometry.computeFaceNormals())}),a.updateMatrixWorld(!0),d(a),c&&c(a),k(a)}a.geometries.forEach(function(a){if("TextGeometry"===a.type){a.parameters.font=b[a.font_url];var c=new THREE.TextGeometry(a.text,a.parameters);c.uuid=a.uuid,void 0!==a.name&&(c.name=a.name),n[a.uuid]=c}}),e=f.parseImages(a.images,function(){g(j)});var h=f.parseTextures(a.textures,e),i=f.parseMaterials(a.materials,h),j=f.parseObject(a.object,n,i);void 0!==a.images&&0!==a.images.length||g(j)}var n=f.parseGeometries(a.geometries.filter(function(a){return"TextGeometry"!==a.type}));g.onLoad=m;var o=!1;a.materials&&a.materials.forEach(function(a){if(a.type.endsWith("ShaderMaterial")&&a.uniforms){var b=a.uniforms;for(var c in b){var d=b[c];"t"===d.type&&(Array.isArray(d.value)&&6===d.value.length?(d.value=i.load(d.value),o=!0):"string"==typeof d.value&&(d.value=h.load(d.value),o=!0))}}}),a.geometries.forEach(function(a){"TextGeometry"===a.type&&void 0===b[a.font_url]&&(b[a.font_url]=null,j.load(a.font_url,function(c){b[a.font_url]=c}),o=!0)}),o===!1&&m()});return k}var b={};return{parse:a,fonts:b}}(),THREE.py.CANNONize=function(a,b){"use strict";function c(a,b){var d;if(a.body)return a.body;if(a instanceof THREE.Mesh){var e={mass:b.mass,position:a.getWorldPosition(),quaternion:a.getWorldQuaternion()};return void 0!==b.linearDamping&&(e.linearDamping=b.linearDamping),void 0!==b.angularDamping&&(e.angularDamping=b.angularDamping),d=new CANNON.Body(e),d.mesh=a,b.shapes.forEach(function(b){var c,e,f,g,h,i;switch(b){case"Plane":c=new CANNON.Plane;break;case"Box":var j=new CANNON.Vec3;a.geometry.computeBoundingBox(),j.x=a.scale.x*(a.geometry.boundingBox.max.x-a.geometry.boundingBox.min.x)/2,j.y=a.scale.y*(a.geometry.boundingBox.max.y-a.geometry.boundingBox.min.y)/2,j.z=a.scale.z*(a.geometry.boundingBox.max.z-a.geometry.boundingBox.min.z)/2,c=new CANNON.Box(j);break;case"Sphere":a.geometry.computeBoundingSphere(),c=new CANNON.Sphere(a.geometry.boundingSphere.radius);break;case"ConvexPolyhedron":var k=[],l=[];if(a.geometry instanceof THREE.BufferGeometry){for(g=a.geometry.getAttribute("position").array,i=0;i<g.length;i+=3)k.push(new CANNON.Vec3(g[i],g[i+1],g[i+2]));for(g=a.geometry.index.array,i=0;i<g.length;i+=3)h=[g[i],g[i+1],g[i+2]],l.push(h)}else a.geometry instanceof THREE.Geometry;c=new CANNON.ConvexPolyhedron(k,l);break;case"Cylinder":c=new CANNON.Cylinder(a.geometry.parameters.radiusTop,a.geometry.parameters.radiusBottom,a.geometry.parameters.height,a.geometry.parameters.radialSegments),e=new CANNON.Quaternion,e.setFromEuler(-Math.PI/2,0,0,"XYZ");break;case"Heightfield":g=a.geometry.getAttribute("position").array,"PlaneBufferGeometry"!==a.geometry.type&&alert("uh oh!");for(var m=a.geometry.parameters.widthSegments+1,n=a.geometry.parameters.heightSegments+1,o=a.geometry.parameters.width/a.geometry.parameters.widthSegments,p=[],q=0;m>q;++q){p.push(new Float32Array(n));for(var r=0;n>r;++r)p[q][r]=g[3*(m*(n-r-1)+q)+2]}c=new CANNON.Heightfield(p,{elementSize:o}),f=new CANNON.Vec3,f.x=-a.geometry.parameters.width/2,f.y=-a.geometry.parameters.height/2;break;case"Trimesh":var s,t;if(a.geometry instanceof THREE.BufferGeometry)s=a.geometry.getAttribute("position").array,t=a.geometry.index.array;else{for(s=[],i=0;i<a.geometry.vertices.length;i++){var u=a.geometry.vertices[i];s.push(u.x,u.y,u.z)}for(t=[],i=0;i<a.geometry.faces.length;i++)h=a.geometry.faces[i],t.push(h.a,h.b,h.c)}c=new CANNON.Trimesh(s,t);break;case"Ellipsoid":console.warn("TODO");break;default:console.error("unknown shape type: "+b)}d.addShape(c,f,e)}),a.body=d,d}if(a instanceof THREE.Object3D){var f=[];return a.children.forEach(function(a){f.push(c(a,b))}),f}console.error("makeCANNON error")}a.updateMatrixWorld(),a.traverse(function(a){if(a.userData&&a.userData.cannonData){var d=c(a,a.userData.cannonData);b&&(d instanceof CANNON.Body?b.addBody(d):d.forEach(function(a){b.addBody(a)}))}})};var TextGeomUtils=function(){"use strict";function a(a,b){b=b||{};var c={font:a,size:b.size||.12,height:b.height||0,curveSegments:b.curveSegments||2};this.geometries={};for(var d=0;d<f.length;d++){var e=f[d],g=new THREE.TextGeometry(e,c),h=new THREE.BufferGeometry;h.fromGeometry(g),g.dispose(),this.geometries[e]=h}this.makeObject=function(a,b){var d=new THREE.Object3D;d.matrixAutoUpdate=!1;for(var e=0;e<a.length;e++){var f=a[e];if(" "!==f){var g=new THREE.Mesh(this.geometries[f],b);g.matrixAutoUpdate=!1,g.position.x=.8*c.size*e,g.updateMatrix(),d.add(g)}}return d}.bind(this)}function b(a,b){b=b||{};var c=b.material||new THREE.MeshBasicMaterial({color:16720385}),d=b.nrows||20,e=(b.ncols||30,b.lineHeight||.216),f={};this.root=new THREE.Object3D,this.root.matrixAutoUpdate=!1,this.log=function(b){for(var g=b.split(/\n/),h=0;h<g.length;h++){var i=g[h],j=f[i];if(j){var k=j.clone();this.root.add(k)}else j=a.makeObject(i,c),this.root.add(j),f[i]=j}for(h=this.root.children.length-1;h>=d;h--)this.root.remove(this.root.children[h]);for(h=0;h<this.root.children.length;h++){var l=this.root.children[h];l.position.y=(this.root.children.length-h)*e,l.updateMatrix()}this.root.updateMatrixWorld(!0)}.bind(this),this.clear=function(){for(var a=this.root.children.length-1;a>=0;a--)this.root.remove(this.root.children[a])}.bind(this)}var c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",d="0123456789",e=",./;'[]\\-=<>?:\"{}|_+~!@#$%^&*()",f=c+d+e;return{TextGeomCacher:a,TextGeomLogger:b}}(),URL_PARAMS=function(){"use strict";var a={};location.search.substr(1).split("&").forEach(function(b){var c=b.split("=")[0],d=decodeURIComponent(b.split("=")[1]);c in a?a[c].push(d):a[c]=[d]});for(var b in a)1===a[b].length&&(a[b]=a[b][0]),"true"===a[b]?a[b]=!0:"false"===a[b]&&(a[b]=!1);return a}(),WebVRSound=function(a){"use strict";function b(){var b=d[g];return g=(g+1)%a,b}a=a||4;for(var c=new AudioContext,d=[],e=0;a>e;e++){var f=c.createGain();f.connect(c.destination),f.gain.value=1,d.push(f)}var g=0,h=function(a,d){var e=c.createBufferSource(),f=b();f.gain.value=d,e.connect(f),e.buffer=a,e.start(0)};return{audioContext:c,getNextGainNode:b,playBuffer:h}}(),SynthSpeaker=function(){"use strict";function a(a){a=a||{},this.volume=a.volume||1,this.rate=a.rate||1,this.pitch=a.pitch||1,this.queue=[],this.onBegins=[],this.onEnds=[],this.speaking=!1;var b=function(){var a=this.onEnds.shift();if(a&&a(),this.utterance=new SpeechSynthesisUtterance,this.utterance.volume=this.volume,this.utterance.rate=this.rate,this.utterance.pitch=this.pitch,this.utterance.onend=b,this.queue.length>0){this.utterance.text=this.queue.shift();var c=this.onBegins.shift();c&&c(),speechSynthesis.speak(this.utterance)}else this.speaking=!1}.bind(this);this.utterance=new SpeechSynthesisUtterance,this.utterance.onend=b,this.utterance.volume=this.volume,this.utterance.rate=this.rate,this.utterance.pitch=this.pitch}return a.prototype.speak=function(a,b,c){this.onEnds.push(c),this.speaking?(this.queue.push(a),this.onBegins.push(b)):(b&&b(),this.utterance.text=a,this.speaking=!0,speechSynthesis.speak(this.utterance))},window.speechSynthesis?a:(console.warn("speechSynthesis not supported"),function(){this.volume=0,this.rate=1,this.pitch=1,this.speak=function(a,b,c){b&&b(),c&&c()}})}();POOLVR.commands={toggleVRControls:function(){POOLVR.app.toggleVRControls(),POOLVR.app.camera.updateMatrix()},toggleWireframe:function(){POOLVR.app.toggleWireframe()},resetVRSensor:function(){POOLVR.app.resetVRSensor()},resetTable:function(){POOLVR.resetTable()},autoPosition:function(){POOLVR.autoPosition()},selectNextBall:function(){POOLVR.selectNextBall()},selectPrevBall:function(){POOLVR.selectNextBall(-1)},stroke:function(){POOLVR.stroke()}},POOLVR.keyboardCommands={turnLeft:{buttons:[-Primrose.Input.Keyboard.LEFTARROW]},turnRight:{buttons:[Primrose.Input.Keyboard.RIGHTARROW]},driveForward:{buttons:[-Primrose.Input.Keyboard.W]},driveBack:{buttons:[Primrose.Input.Keyboard.S]},strafeLeft:{buttons:[-Primrose.Input.Keyboard.A]},strafeRight:{buttons:[Primrose.Input.Keyboard.D]},floatUp:{buttons:[Primrose.Input.Keyboard.E]},floatDown:{buttons:[-Primrose.Input.Keyboard.C]},moveToolUp:{buttons:[Primrose.Input.Keyboard.O]},moveToolDown:{buttons:[Primrose.Input.Keyboard.PERIOD]},moveToolForwards:{buttons:[Primrose.Input.Keyboard.I]},moveToolBackwards:{buttons:[Primrose.Input.Keyboard.K]},moveToolLeft:{buttons:[Primrose.Input.Keyboard.J]},moveToolRight:{buttons:[Primrose.Input.Keyboard.L]},rotateToolCW:{buttons:[Primrose.Input.Keyboard.U]},rotateToolCCW:{buttons:[Primrose.Input.Keyboard.Y]},toggleVRControls:{buttons:[Primrose.Input.Keyboard.V],commandDown:POOLVR.commands.toggleVRControls,dt:.25},toggleWireframe:{buttons:[Primrose.Input.Keyboard.NUMBER0],commandDown:POOLVR.commands.toggleWireframe,dt:.25},resetVRSensor:{buttons:[Primrose.Input.Keyboard.Z],commandDown:POOLVR.commands.resetVRSensor,dt:.25},resetTable:{buttons:[Primrose.Input.Keyboard.R],commandDown:POOLVR.commands.resetTable,dt:.5},autoPosition:{buttons:[Primrose.Input.Keyboard.P],commandDown:POOLVR.commands.autoPosition,dt:.5},selectNextBall:{buttons:[Primrose.Input.Keyboard.ADD],commandDown:POOLVR.commands.selectNextBall,dt:.5},selectPrevBall:{buttons:[Primrose.Input.Keyboard.SUBTRACT],commandDown:POOLVR.commands.selectPrevBall,dt:.5},stroke:{buttons:[Primrose.Input.Keyboard.SPACEBAR],commandDown:POOLVR.commands.stroke,dt:.25}},POOLVR.keyboardCommands=makeObjectArray(POOLVR.keyboardCommands,"name"),POOLVR.keyboard=new Primrose.Input.Keyboard("keyboard",document,POOLVR.keyboardCommands);var DEADZONE=.2;POOLVR.gamepadCommands={strafe:{axes:[Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},drive:{axes:[Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},"float":{axes:[-Primrose.Input.Gamepad.LSY],deadzone:DEADZONE},dheading:{axes:[-Primrose.Input.Gamepad.LSX],deadzone:DEADZONE},pitch:{axes:[Primrose.Input.Gamepad.LSY],deadzone:DEADZONE,integrate:!0,max:.5*Math.PI,min:-.5*Math.PI},toggleFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.leftStick],commandDown:function(){POOLVR.avatar.floatMode=!0},commandUp:function(){POOLVR.avatar.floatMode=!1}},toolStrafe:{axes:[Primrose.Input.Gamepad.RSX],deadzone:DEADZONE},toolDrive:{axes:[Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toolFloat:{axes:[-Primrose.Input.Gamepad.RSY],deadzone:DEADZONE},toggleToolFloatMode:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.rightStick],commandDown:function(){POOLVR.avatar.toolMode=!0},commandUp:function(){POOLVR.avatar.toolMode=!1}},resetVRSensor:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.back],commandDown:POOLVR.commands.resetVRSensor,dt:.25},selectNextBall:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.rightBumper],commandDown:POOLVR.commands.selectNextBall,dt:.25},selectPrevBall:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.leftBumper],commandDown:POOLVR.commands.selectPrevBall,dt:.25},autoPosition:{buttons:[Primrose.Input.Gamepad.XBOX_BUTTONS.Y],commandDown:POOLVR.commands.autoPosition,dt:.25}},POOLVR.gamepadCommands=makeObjectArray(POOLVR.gamepadCommands,"name"),POOLVR.gamepad=new Primrose.Input.Gamepad("gamepad",POOLVR.gamepadCommands),POOLVR.gamepad.addEventListener("gamepadconnected",function(a){this.isGamepadSet()||(this.setGamepad(a),console.log("gamepad "+a+" connected"))}.bind(POOLVR.gamepad),!1),POOLVR.parseURIConfig=function(){"use strict";POOLVR.config.useTextGeomLogger=void 0!==URL_PARAMS.useTextGeomLogger?URL_PARAMS.useTextGeomLogger:POOLVR.config.useTextGeomLogger,POOLVR.config.synthSpeakerVolume=URL_PARAMS.synthSpeakerVolume||POOLVR.config.synthSpeakerVolume,POOLVR.config.initialPosition=POOLVR.config.initialPosition,POOLVR.config.toolOptions=POOLVR.config.toolOptions||{},POOLVR.config.toolOptions.toolLength=URL_PARAMS.toolLength||POOLVR.config.toolOptions.toolLength,POOLVR.config.toolOptions.toolRadius=URL_PARAMS.toolRadius||POOLVR.config.toolOptions.toolRadius,POOLVR.config.toolOptions.toolMass=URL_PARAMS.toolMass||POOLVR.config.toolOptions.toolMass,POOLVR.config.toolOptions.toolOffset=URL_PARAMS.toolOffset||POOLVR.config.toolOptions.toolOffset,POOLVR.config.toolOptions.toolRotation=URL_PARAMS.toolRotation||POOLVR.config.toolOptions.toolRotation,POOLVR.config.toolOptions.tipShape=URL_PARAMS.tipShape||POOLVR.config.toolOptions.tipShape,POOLVR.config.toolOptions.host=URL_PARAMS.host,POOLVR.config.toolOptions.port=URL_PARAMS.port,POOLVR.config.useBasicMaterials=void 0!==URL_PARAMS.useBasicMaterials?URL_PARAMS.useBasicMaterials:POOLVR.config.useBasicMaterials,POOLVR.config.useBasicMaterials?(POOLVR.config.usePointLight=!1,POOLVR.config.useShadowMap=!1):(POOLVR.config.usePointLight=void 0!==URL_PARAMS.usePointLight?URL_PARAMS.usePointLight:POOLVR.config.usePointLight,POOLVR.config.useShadowMap=void 0!==URL_PARAMS.useShadowMap?URL_PARAMS.useShadowMap:POOLVR.config.useShadowMap),POOLVR.config.rendererOptions={antialias:void 0!==URL_PARAMS.antialias?URL_PARAMS.antialias:isMobile()===!1}},POOLVR.profile=URL_PARAMS.profile||POOLVR.profile||"default",POOLVR.saveConfig=function(a){"use strict";POOLVR.config.toolOptions.toolOffset=[POOLVR.toolRoot.position.x,POOLVR.toolRoot.position.y,POOLVR.toolRoot.position.z],POOLVR.config.toolOptions.toolRotation=POOLVR.toolRoot.rotation.y,localStorage.setItem(a,JSON.stringify(POOLVR.config)),console.log("saved configuration for profile '"+a+"':"),console.log(JSON.stringify(POOLVR.config,void 0,2))},POOLVR.loadConfig=function(a){"use strict";var b,c=localStorage.getItem(a);if(c){b={},c=JSON.parse(c);for(var d in c)POOLVR.config.hasOwnProperty(d)&&(b[d]=c[d]);console.log("loaded configuration for profile '"+a+"'")}return b},POOLVR.ballMaterial=new CANNON.Material,POOLVR.ballBallContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.ballMaterial,{restitution:.92,friction:.14}),POOLVR.playableSurfaceMaterial=new CANNON.Material,POOLVR.ballPlayableSurfaceContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.playableSurfaceMaterial,{restitution:.3,friction:.21}),POOLVR.cushionMaterial=new CANNON.Material,POOLVR.ballCushionContactMaterial=new CANNON.ContactMaterial(POOLVR.ballMaterial,POOLVR.cushionMaterial,{restitution:.8,friction:.12}),POOLVR.floorMaterial=new CANNON.Material,POOLVR.floorBallContactMaterial=new CANNON.ContactMaterial(POOLVR.floorMaterial,POOLVR.ballMaterial,{restitution:.86,friction:.4}),POOLVR.railMaterial=new CANNON.Material,POOLVR.railBallContactMaterial=new CANNON.ContactMaterial(POOLVR.railMaterial,POOLVR.ballMaterial,{restitution:.7,friction:.07}),POOLVR.tipMaterial=new CANNON.Material,POOLVR.tipBallContactMaterial=new CANNON.ContactMaterial(POOLVR.tipMaterial,POOLVR.ballMaterial,{restitution:.01,friction:.15,contactEquationRelaxation:3,frictionEquationRelaxation:3}),POOLVR.ballMeshes=[],POOLVR.ballBodies=[],POOLVR.initialPositions=[],POOLVR.onTable=[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],POOLVR.nextBall=1,POOLVR.playCollisionSound=function(){"use strict";var a,b=new XMLHttpRequest;b.responseType="arraybuffer",b.open("GET","sounds/ballBall.ogg"),b.onload=function(){WebVRSound.audioContext.decodeAudioData(this.response,function(b){a=b})},b.send();var c=function(b){WebVRSound.playBuffer(a,Math.min(1,b/10))};return c}(),POOLVR.playPocketedSound=function(){"use strict";var a,b=new XMLHttpRequest;b.responseType="arraybuffer",b.open("GET","sounds/ballPocketed.ogg"),b.onload=function(){WebVRSound.audioContext.decodeAudioData(this.response,function(b){a=b})},b.send();var c=function(){WebVRSound.playBuffer(a,.5)};return c}(),POOLVR.setup=function(){"use strict";var a=new CANNON.World;a.gravity.set(0,-POOLVR.config.gravity,0),a.defaultContactMaterial.contactEquationStiffness=1e6,a.defaultContactMaterial.frictionEquationStiffness=1e6,a.defaultContactMaterial.contactEquationRelaxation=3,a.defaultContactMaterial.frictionEquationRelaxation=3,a.solver.iterations=9,POOLVR.world=a;var b=POOLVR.app.scene;THREE.py.CANNONize(b,a),a.addMaterial(POOLVR.ballMaterial),a.addMaterial(POOLVR.playableSurfaceMaterial),a.addMaterial(POOLVR.cushionMaterial),a.addMaterial(POOLVR.floorMaterial),a.addMaterial(POOLVR.tipMaterial),a.addMaterial(POOLVR.railMaterial),a.addContactMaterial(POOLVR.ballBallContactMaterial),a.addContactMaterial(POOLVR.ballPlayableSurfaceContactMaterial),a.addContactMaterial(POOLVR.ballCushionContactMaterial),a.addContactMaterial(POOLVR.floorBallContactMaterial),a.addContactMaterial(POOLVR.tipBallContactMaterial),a.addContactMaterial(POOLVR.railBallContactMaterial);var c=addTool(POOLVR.avatar,POOLVR.world,combineObjects(POOLVR.config.toolOptions,{onConnect:function(){POOLVR.leapIndicator.innerHTML="connected"},onDisconnect:function(){
POOLVR.leapIndicator.innerHTML="disconnected"}}));POOLVR.leapController=c.leapController,POOLVR.toolRoot=c.toolRoot,POOLVR.updateTool=c.updateTool,POOLVR.updateToolPostStep=c.updateToolPostStep,POOLVR.moveToolRoot=c.moveToolRoot;var d={},e={};POOLVR.switchMaterials=function(a){var b=a?d:e;POOLVR.app.scene.traverse(function(a){if(a instanceof THREE.Mesh){var c=a.material,d=c.name;b[d]&&(a.material=b[d])}})};var f;b.traverse(function(a){if(a instanceof THREE.Mesh){if(a.material.name&&void 0===e[a.material.name]&&(a.material instanceof THREE.MeshLambertMaterial||a.material instanceof THREE.MeshPhongMaterial)){e[a.material.name]=a.material;var b=new THREE.MeshBasicMaterial({color:a.material.color.getHex(),transparent:a.material.transparent,side:a.material.side});b.name=a.material.name,d[a.material.name]=b}var c;a.name.startsWith("ballMesh")?(c=Number(a.name.split(" ")[1]),POOLVR.ballMeshes[c]=a,POOLVR.ballBodies[c]=a.body,POOLVR.initialPositions[c]=(new THREE.Vector3).copy(a.position),a.body.bounces=0,a.body.ballNum=c,a.body.material=POOLVR.ballMaterial):"playableSurfaceMesh"===a.name?a.body.material=POOLVR.playableSurfaceMaterial:a.name.endsWith("CushionMesh")?a.body.material=POOLVR.cushionMaterial:"floorMesh"===a.name?(f=a.body,f.material=POOLVR.floorMaterial):a.name.endsWith("RailMesh")&&(a.body.material=POOLVR.railMaterial)}});var g=POOLVR.config.H_table,h=POOLVR.config.useShadowMap;if(!h){var i=[],j=new THREE.CircleBufferGeometry(.5*POOLVR.config.ball_diameter,16);j.rotateX(-.5*Math.PI);var k=new THREE.MeshBasicMaterial({color:8704});POOLVR.ballMeshes.forEach(function(a,c){var d=new THREE.Mesh(j,k);d.position.copy(a.position),d.position.y=g+4e-4,i[c]=d,b.add(d)})}POOLVR.updateBallsPostStep=function(){for(var a=0;a<POOLVR.ballMeshes.length;a++){var b=POOLVR.ballMeshes[a],c=POOLVR.ballBodies[a];if(b.position.copy(c.interpolatedPosition),b.quaternion.copy(c.interpolatedQuaternion),b.updateMatrix(),b.updateMatrixWorld(),!h){var d=i[a];d.position.x=b.position.x,d.position.z=b.position.z,d.updateMatrix(),d.updateMatrixWorld()}}},f.addEventListener(CANNON.Body.COLLIDE_EVENT_NAME,function(a){var b=a.body;0===b.ballNum?(POOLVR.textGeomLogger.log("SCRATCH."),POOLVR.synthSpeaker.speak("Scratch."),b.position.copy(POOLVR.initialPositions[0]),b.velocity.set(0,0,0),b.angularVelocity.set(0,0,0)):void 0!==b.ballNum&&(b.bounces++,1===b.bounces?(POOLVR.playPocketedSound(),POOLVR.onTable[b.ballNum]=!1,POOLVR.nextBall=POOLVR.onTable.slice(1).indexOf(!0)+1,0===POOLVR.nextBall&&(POOLVR.synthSpeaker.speak("You cleared the table.  Well done."),POOLVR.textGeomLogger.log("YOU CLEARED THE TABLE.  WELL DONE."),POOLVR.resetTable())):7===b.bounces&&(b.sleep(),b.mesh.visible=!1))});var l=new CANNON.Vec3;a.addEventListener("beginContact",function(a){var b=a.bodyA,c=a.bodyB;b.material===c.material&&(b.velocity.vsub(c.velocity,l),POOLVR.playCollisionSound(l.lengthSquared()))})},POOLVR.setupMenu=function(){"use strict";function a(a){POOLVR.keyboard.enabled=!1}function b(a){POOLVR.keyboard.enabled=!0}for(var c=document.querySelectorAll("input"),d=0;d<c.length;d++)c[d].addEventListener("focus",a),c[d].addEventListener("blur",b);var e=document.getElementById("useBasicMaterials");e.checked=POOLVR.config.useBasicMaterials,e.addEventListener("change",function(a){POOLVR.config.useBasicMaterials=e.checked,POOLVR.saveConfig(POOLVR.profile),POOLVR.switchMaterials(POOLVR.config.useBasicMaterials)});var f=document.getElementById("useShadowMap");f.checked=POOLVR.config.useShadowMap,f.addEventListener("change",function(a){POOLVR.config.useShadowMap=f.checked,POOLVR.saveConfig(POOLVR.profile),window.confirm("This change requires a page reload to take effect - reload now?")&&document.location.reload()}),POOLVR.leapIndicator=document.getElementById("leapIndicator");var g=document.getElementById("leapAddress");g.value="localhost",g.addEventListener("change",function(a){POOLVR.leapController.connection.host=g.value,POOLVR.leapController.connection.disconnect(!0),POOLVR.leapController.connect()});var h=document.getElementById("profileName");h.value=POOLVR.profile,h.addEventListener("change",function(a){POOLVR.profile=h.value,POOLVR.saveConfig(POOLVR.profile)});var i=document.getElementById("overlay"),j=document.getElementById("start");j.addEventListener("click",function(){i.style.display="none",POOLVR.startTutorial()}),j.disabled=!1},POOLVR.selectNextBall=function(a){"use strict";a=a||1;for(var b=Math.max(1,Math.min(15,POOLVR.nextBall+a));!POOLVR.onTable[b]&&(b=Math.max(1,Math.min(15,b+a)),b!==POOLVR.nextBall););POOLVR.nextBall!==b&&(POOLVR.nextBall=b,POOLVR.textGeomLogger.log("BALL "+POOLVR.nextBall+" SELECTED"))},POOLVR.resetTable=function(){"use strict";POOLVR.ballBodies.forEach(function(a,b){a.wakeUp(),a.position.copy(POOLVR.initialPositions[b]),a.velocity.set(0,0,0),a.angularVelocity.set(0,0,0),a.bounces=0,POOLVR.onTable[b]=!0,a.mesh.visible=!0}),POOLVR.synthSpeaker.speaking===!1&&POOLVR.synthSpeaker.speak("Table reset."),POOLVR.nextBall=1,POOLVR.textGeomLogger.log("TABLE RESET.")},POOLVR.autoPosition=function(){"use strict";var a=new THREE.Vector3,b=THREE.Object3D.DefaultUp;return function(){POOLVR.synthSpeaker.speaking===!1&&POOLVR.synthSpeaker.speak("You are being auto-positioned.");var c=POOLVR.avatar;c.heading=Math.atan2(-(POOLVR.ballMeshes[POOLVR.nextBall].position.x-POOLVR.ballMeshes[0].position.x),-(POOLVR.ballMeshes[POOLVR.nextBall].position.z-POOLVR.ballMeshes[0].position.z)),c.quaternion.setFromAxisAngle(b,c.heading),a.copy(POOLVR.toolRoot.position),a.applyQuaternion(c.quaternion),a.add(c.position),a.sub(POOLVR.ballMeshes[0].position),a.y=0,c.position.sub(a),c.updateMatrix(),c.updateMatrixWorld();var d=POOLVR.toolRoot;d.matrixWorldInverse.getInverse(d.matrixWorld),d.matrixWorld.decompose(d.worldPosition,d.worldQuaternion,d.worldScale)}}(),POOLVR.moveAvatar=function(){"use strict";var a=THREE.Object3D.DefaultUp,b=.333,c=.1;return function(d,e,f){var g=POOLVR.avatar,h=d.getValue("floatUp")+d.getValue("floatDown"),i=d.getValue("driveBack")+d.getValue("driveForward"),j=d.getValue("strafeRight")+d.getValue("strafeLeft"),k=-.8*f*(d.getValue("turnLeft")+d.getValue("turnRight"));if(g.floatMode?(h+=e.getValue("float"),j+=e.getValue("strafe")):(i+=e.getValue("drive"),k+=.8*f*e.getValue("dheading")),h*=c,j||i){var l=b*Math.min(1,1/Math.sqrt(i*i+j*j));j*=l,i*=l}else j=0,i=0;if(0!==h||0!==j||0!==k||0!==i){g.heading+=k;var m=Math.cos(g.heading),n=Math.sin(g.heading);g.quaternion.setFromAxisAngle(a,g.heading),g.position.x+=f*(j*m+i*n),g.position.z+=f*(i*m-j*n),g.position.y+=f*h,g.updateMatrix(),g.updateMatrixWorld();var o=POOLVR.toolRoot;o.matrixWorldInverse.getInverse(o.matrixWorld),o.matrixWorld.decompose(o.worldPosition,o.worldQuaternion,o.worldScale)}}}(),POOLVR.stroke=function(){"use strict";var a=POOLVR.ballBodies[0];a.velocity.z=-3.5},POOLVR.startTutorial=function(){"use strict";POOLVR.synthSpeaker.speak("Hello.  Welcome. To. Pool-ver.",function(){POOLVR.textGeomLogger.log("HELLO.  WELCOME TO POOLVR.")}),POOLVR.synthSpeaker.speak("Please wave a stick-like object in front of your Leap Motion controller.",function(){POOLVR.textGeomLogger.log("PLEASE WAVE A STICK-LIKE OBJECT IN FRONT OF YOUR"),POOLVR.textGeomLogger.log("LEAP MOTION CONTROLLER.")}),POOLVR.synthSpeaker.speak("Keep the stick within the interaction box when you want to make contact with.  A ball.",function(){POOLVR.textGeomLogger.log("KEEP THE STICK WITHIN THE INTERACTION BOX WHEN YOU WANT"),POOLVR.textGeomLogger.log("TO MAKE CONTACT WITH A BALL...")})},POOLVR.startAnimateLoop=function(){"use strict";function a(m){c("frame").start(),b.start(),c("raf").tick(),c("fps").frame();var o=.001*(m-n);c("updatetool").start(),h(),c("updatetool").end(),c("updatevrcontrols").start(),f.vrControlsEnabled&&(f.vrControls.update(),f.camera.updateMatrixWorld()),c("updatevrcontrols").end(),c("render").start(),f.vrEffect.render(f.scene,f.camera),c("render").end(),c("step").start(),g.step(Math.min(1/60,o),o,10),c("step").end(),c("poststep").start(),i(),l(),c("poststep").end(),c("updatekeyboardgamepad").start(),d.update(o),e.update(o),k(d,e,o),j(d,e,o),c("updatekeyboardgamepad").end(),n=m,requestAnimationFrame(a),c("frame").end(),c().update()}var b,c,d=POOLVR.keyboard,e=POOLVR.gamepad,f=POOLVR.app,g=POOLVR.world,h=POOLVR.updateTool,i=POOLVR.updateToolPostStep,j=POOLVR.moveToolRoot,k=POOLVR.moveAvatar,l=POOLVR.updateBallsPostStep;if(URL_PARAMS.rstats){var m=new threeStats(POOLVR.app.renderer);b=new glStats,c=new rStats({CSSPath:"lib/rstats/",values:{frame:{caption:"Total frame time (ms)"},calls:{caption:"Calls (three.js)"},raf:{caption:"Time since last rAF (ms)"},updatetool:{caption:"Leap frame update (ms)"},updatevrcontrols:{caption:"VRControls update (ms)"},step:{caption:"Cannon step (ms)"},poststep:{caption:"Cannon post-step (ms)"},updatekeyboardgamepad:{caption:"Move avatar / Leap (ms)"}},fractions:[{base:"frame",steps:["updatetool","updatevrcontrols","render","step","poststep","updatekeyboardgamepad"]}],plugins:[m,b]})}else b={start:function(){}},c=function(a){return{start:function(){},end:function(){},tick:function(){},frame:function(){},update:function(){}}};var n=0;requestAnimationFrame(a)};